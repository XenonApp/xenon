{"version":3,"sources":["../../../src/js/fs/socket.js"],"names":["axios","require","io","history","socket","module","exports","plugin","options","fsUtil","niceName","url","auth","username","user","password","pass","keep","mode","fileModeFilename","watcher","capabilities","pushProject","fullUrl","get","then","response","data","listFiles","res","filter","item","readFile","path","binary","Promise","resolve","JSON","stringify","reject","$","ajax","type","undefined","error","xhr","status","success","setCacheTag","getResponseHeader","uint8ArrayToBinaryString","Uint8Array","dataType","writeFile","content","lockFile","binaryStringAsUint8Array","contentType","processData","unlockFile","statusText","deleteFile","watchFile","callback","unwatchFile","getCacheTag","newEtag","run","command","stdin","action","api","getCapabilities"],"mappings":"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","file":"socket.js","sourcesContent":["'use strict';\n\n// TODO: fix this fs\nconst axios = require('axios');\nconst io = require('socket.io-client');\nconst history = require('../history');\n\nlet socket;\n\nmodule.exports = function plugin(options) {\n    var fsUtil = require(\"./util\");\n    var niceName = require(\"../lib/url_extractor\").niceName;\n\n    var url = options.url;\n    const auth = {\n        username: options.user,\n        password: options.pass\n    };\n    var keep = options.keep;\n\n    socket = io(url);\n\n    var mode = \"directory\"; // or: file\n    var fileModeFilename; // if mode === \"file\"\n    var watcher;\n    var capabilities = {};\n\n    if (keep) {\n        history.pushProject(niceName(url), options.fullUrl);\n    }\n\n    axios.get(`${url}/capablities`, { auth })\n        .then(response => capabilities = response.data);\n\n    function listFiles() {\n        return axios.get(`${url}/filelist`)\n            .then(res => res.data.filter(item => !!item));\n    }\n\n    function readFile(path, binary) {\n        if (mode === \"file\") {\n            if (path === \"/.zedstate\") {\n                return Promise.resolve(JSON.stringify({\n                    \"session.current\": [fileModeFilename]\n                }));\n            }\n            if (path !== fileModeFilename) {\n                return Promise.reject(404);\n            }\n        }\n        return new Promise(function(resolve, reject) {\n            $.ajax({\n                type: \"GET\",\n                url: url + path,\n                username: user || undefined,\n                password: pass || undefined,\n                error: function(xhr) {\n                    reject(xhr.status);\n                },\n                success: function(res, status, xhr) {\n                    watcher.setCacheTag(path, xhr.getResponseHeader(\"ETag\"));\n                    if(binary) {\n                        res = fsUtil.uint8ArrayToBinaryString(new Uint8Array(res));\n                    }\n                    resolve(res);\n                },\n                dataType: binary ? \"arraybuffer\" : \"text\"\n            });\n        });\n    }\n\n    function writeFile(path, content, binary) {\n        if (mode === \"file\") {\n            // Ignore state saves\n            if (path === \"/.zedstate\") {\n                return Promise.resolve();\n            }\n            if (path !== fileModeFilename) {\n                return Promise.reject(500);\n            }\n        }\n        watcher.lockFile(path);\n        return new Promise(function(resolve, reject) {\n            $.ajax(url + path, {\n                type: 'PUT',\n                data: binary ? fsUtil.binaryStringAsUint8Array(content) : content,\n                // dataType: 'text',\n                contentType: 'application/octet-stream',\n                processData: false,\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(res, status, xhr) {\n                    watcher.setCacheTag(path, xhr.getResponseHeader(\"ETag\"));\n                    watcher.unlockFile(path);\n                    resolve(res);\n                },\n                error: function(xhr) {\n                    watcher.unlockFile(path);\n                    reject(xhr.status || xhr.statusText);\n                }\n            });\n        });\n    }\n\n    function deleteFile(path) {\n        return new Promise(function(resolve, reject) {\n            $.ajax(url + path, {\n                type: 'DELETE',\n                dataType: 'text',\n                success: reject,\n                username: user || undefined,\n                password: pass || undefined,\n                error: function(xhr) {\n                    resolve(xhr.status);\n                }\n            });\n        });\n    }\n\n    function watchFile(path, callback) {\n        watcher.watchFile(path, callback);\n    }\n\n    function unwatchFile(path, callback) {\n        watcher.unwatchFile(path, callback);\n    }\n\n    function getCacheTag(path) {\n        return new Promise(function(resolve, reject) {\n            $.ajax(url + path, {\n                type: 'HEAD',\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(data, status, xhr) {\n                    var newEtag = xhr.getResponseHeader(\"ETag\");\n                    resolve(newEtag);\n                },\n                error: function(xhr) {\n                    reject(xhr.status);\n                }\n            });\n        });\n    }\n\n    function run(command, stdin) {\n        return new Promise(function(resolve, reject) {\n            $.ajax(url, {\n                type: \"POST\",\n                url: url,\n                data: {\n                    action: 'run',\n                    command: JSON.stringify(command),\n                    stdin: stdin\n                },\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(res) {\n                    resolve(res);\n                },\n                error: function(xhr) {\n                    reject(xhr.status);\n                },\n                dataType: \"text\"\n            });\n        });\n    }\n\n    var api = {\n        listFiles: listFiles,\n        readFile: readFile,\n        writeFile: writeFile,\n        deleteFile: deleteFile,\n        watchFile: watchFile,\n        unwatchFile: unwatchFile,\n        getCacheTag: getCacheTag,\n        getCapabilities: function() {\n            return capabilities;\n        },\n        run: run\n    };\n\n    return api;\n};\n"]}