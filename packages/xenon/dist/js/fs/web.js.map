{"version":3,"sources":["../../../src/js/fs/web.js"],"names":["history","require","module","exports","plugin","options","poll_watcher","fsUtil","niceName","url","user","pass","keep","mode","fileModeFilename","watcher","capabilities","promisedAjax","obj","Promise","resolve","reject","username","undefined","password","success","error","$","ajax","listFiles","type","data","action","res","items","split","i","length","splice","xhr","status","dataType","readFile","path","binary","JSON","stringify","setCacheTag","getResponseHeader","uint8ArrayToBinaryString","Uint8Array","writeFile","content","lockFile","binaryStringAsUint8Array","contentType","processData","unlockFile","statusText","deleteFile","watchFile","callback","unwatchFile","getCacheTag","newEtag","run","command","stdin","api","getCapabilities","pushProject","fullUrl","urlParts","slice","join","console","log","then","result"],"mappings":"AAAA;;AAEA;;AACA,MAAMA,UAAUC,QAAQ,YAAR,CAAhB;;AAEAC,OAAOC,OAAP,GAAiB,SAASC,MAAT,CAAgBC,OAAhB,EAAyB;AACtC,QAAIC,eAAeL,QAAQ,gBAAR,CAAnB;AACA,QAAIM,SAASN,QAAQ,QAAR,CAAb;AACA,QAAIO,WAAWP,QAAQ,sBAAR,EAAgCO,QAA/C;;AAEA,QAAIC,MAAMJ,QAAQI,GAAlB;AACA,QAAIC,OAAOL,QAAQK,IAAnB;AACA,QAAIC,OAAON,QAAQM,IAAnB;AACA,QAAIC,OAAOP,QAAQO,IAAnB;;AAEA,QAAIC,OAAO,WAAX,CAVsC,CAUd;AACxB,QAAIC,gBAAJ,CAXsC,CAWhB;AACtB,QAAIC,OAAJ;AACA,QAAIC,eAAe,EAAnB;;AAEA,aAASC,YAAT,CAAsBC,GAAtB,EAA2B;AACvB,eAAO,IAAIC,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCH,gBAAII,QAAJ,GAAeZ,QAAQa,SAAvB;AACAL,gBAAIM,QAAJ,GAAeb,QAAQY,SAAvB;AACAL,gBAAIO,OAAJ,GAAcL,OAAd;AACAF,gBAAIQ,KAAJ,GAAYL,MAAZ;AACAM,cAAEC,IAAF,CAAOV,GAAP;AACH,SANM,CAAP;AAOH;;AAED,aAASW,SAAT,GAAqB;AACjB,eAAO,IAAIV,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzC,gBAAIR,SAAS,MAAb,EAAqB;AACjB,uBAAOO,QAAQ,CAACN,gBAAD,CAAR,CAAP;AACH;AACDa,cAAEC,IAAF,CAAO;AACHE,sBAAM,MADH;AAEHrB,qBAAKA,GAFF;AAGHsB,sBAAM;AACFC,4BAAQ;AADN,iBAHH;AAMHV,0BAAUZ,QAAQa,SANf;AAOHC,0BAAUb,QAAQY,SAPf;AAQHE,yBAAS,UAASQ,GAAT,EAAc;AACnB,wBAAIC,QAAQD,IAAIE,KAAJ,CAAU,IAAV,CAAZ;AACA,yBAAK,IAAIC,IAAI,CAAb,EAAgBA,IAAIF,MAAMG,MAA1B,EAAkCD,GAAlC,EAAuC;AACnC,4BAAI,CAACF,MAAME,CAAN,CAAL,EAAe;AACXF,kCAAMI,MAAN,CAAaF,CAAb,EAAgB,CAAhB;AACAA;AACH;AACJ;AACDhB,4BAAQc,KAAR;AACH,iBAjBE;AAkBHR,uBAAO,UAASa,GAAT,EAAc;AACjBlB,2BAAOkB,IAAIC,MAAX;AACH,iBApBE;AAqBHC,0BAAU;AArBP,aAAP;AAuBH,SA3BM,CAAP;AA4BH;;AAED,aAASC,QAAT,CAAkBC,IAAlB,EAAwBC,MAAxB,EAAgC;AAC5B,YAAI/B,SAAS,MAAb,EAAqB;AACjB,gBAAI8B,SAAS,YAAb,EAA2B;AACvB,uBAAOxB,QAAQC,OAAR,CAAgByB,KAAKC,SAAL,CAAe;AAClC,uCAAmB,CAAChC,gBAAD;AADe,iBAAf,CAAhB,CAAP;AAGH;AACD,gBAAI6B,SAAS7B,gBAAb,EAA+B;AAC3B,uBAAOK,QAAQE,MAAR,CAAe,GAAf,CAAP;AACH;AACJ;AACD,eAAO,IAAIF,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCM,cAAEC,IAAF,CAAO;AACHE,sBAAM,KADH;AAEHrB,qBAAKA,MAAMkC,IAFR;AAGHrB,0BAAUZ,QAAQa,SAHf;AAIHC,0BAAUb,QAAQY,SAJf;AAKHG,uBAAO,UAASa,GAAT,EAAc;AACjBlB,2BAAOkB,IAAIC,MAAX;AACH,iBAPE;AAQHf,yBAAS,UAASQ,GAAT,EAAcO,MAAd,EAAsBD,GAAtB,EAA2B;AAChCxB,4BAAQgC,WAAR,CAAoBJ,IAApB,EAA0BJ,IAAIS,iBAAJ,CAAsB,MAAtB,CAA1B;AACA,wBAAGJ,MAAH,EAAW;AACPX,8BAAM1B,OAAO0C,wBAAP,CAAgC,IAAIC,UAAJ,CAAejB,GAAf,CAAhC,CAAN;AACH;AACDb,4BAAQa,GAAR;AACH,iBAdE;AAeHQ,0BAAUG,SAAS,aAAT,GAAyB;AAfhC,aAAP;AAiBH,SAlBM,CAAP;AAmBH;;AAED,aAASO,SAAT,CAAmBR,IAAnB,EAAyBS,OAAzB,EAAkCR,MAAlC,EAA0C;AACtC,YAAI/B,SAAS,MAAb,EAAqB;AACjB;AACA,gBAAI8B,SAAS,YAAb,EAA2B;AACvB,uBAAOxB,QAAQC,OAAR,EAAP;AACH;AACD,gBAAIuB,SAAS7B,gBAAb,EAA+B;AAC3B,uBAAOK,QAAQE,MAAR,CAAe,GAAf,CAAP;AACH;AACJ;AACDN,gBAAQsC,QAAR,CAAiBV,IAAjB;AACA,eAAO,IAAIxB,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCM,cAAEC,IAAF,CAAOnB,MAAMkC,IAAb,EAAmB;AACfb,sBAAM,KADS;AAEfC,sBAAMa,SAASrC,OAAO+C,wBAAP,CAAgCF,OAAhC,CAAT,GAAoDA,OAF3C;AAGf;AACAG,6BAAa,0BAJE;AAKfC,6BAAa,KALE;AAMflC,0BAAUZ,QAAQa,SANH;AAOfC,0BAAUb,QAAQY,SAPH;AAQfE,yBAAS,UAASQ,GAAT,EAAcO,MAAd,EAAsBD,GAAtB,EAA2B;AAChCxB,4BAAQgC,WAAR,CAAoBJ,IAApB,EAA0BJ,IAAIS,iBAAJ,CAAsB,MAAtB,CAA1B;AACAjC,4BAAQ0C,UAAR,CAAmBd,IAAnB;AACAvB,4BAAQa,GAAR;AACH,iBAZc;AAafP,uBAAO,UAASa,GAAT,EAAc;AACjBxB,4BAAQ0C,UAAR,CAAmBd,IAAnB;AACAtB,2BAAOkB,IAAIC,MAAJ,IAAcD,IAAImB,UAAzB;AACH;AAhBc,aAAnB;AAkBH,SAnBM,CAAP;AAoBH;;AAED,aAASC,UAAT,CAAoBhB,IAApB,EAA0B;AACtB,eAAO,IAAIxB,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCM,cAAEC,IAAF,CAAOnB,MAAMkC,IAAb,EAAmB;AACfb,sBAAM,QADS;AAEfW,0BAAU,MAFK;AAGfhB,yBAASJ,MAHM;AAIfC,0BAAUZ,QAAQa,SAJH;AAKfC,0BAAUb,QAAQY,SALH;AAMfG,uBAAO,UAASa,GAAT,EAAc;AACjBnB,4BAAQmB,IAAIC,MAAZ;AACH;AARc,aAAnB;AAUH,SAXM,CAAP;AAYH;;AAED,aAASoB,SAAT,CAAmBjB,IAAnB,EAAyBkB,QAAzB,EAAmC;AAC/B9C,gBAAQ6C,SAAR,CAAkBjB,IAAlB,EAAwBkB,QAAxB;AACH;;AAED,aAASC,WAAT,CAAqBnB,IAArB,EAA2BkB,QAA3B,EAAqC;AACjC9C,gBAAQ+C,WAAR,CAAoBnB,IAApB,EAA0BkB,QAA1B;AACH;;AAED,aAASE,WAAT,CAAqBpB,IAArB,EAA2B;AACvB,eAAO,IAAIxB,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCM,cAAEC,IAAF,CAAOnB,MAAMkC,IAAb,EAAmB;AACfb,sBAAM,MADS;AAEfR,0BAAUZ,QAAQa,SAFH;AAGfC,0BAAUb,QAAQY,SAHH;AAIfE,yBAAS,UAASM,IAAT,EAAeS,MAAf,EAAuBD,GAAvB,EAA4B;AACjC,wBAAIyB,UAAUzB,IAAIS,iBAAJ,CAAsB,MAAtB,CAAd;AACA5B,4BAAQ4C,OAAR;AACH,iBAPc;AAQftC,uBAAO,UAASa,GAAT,EAAc;AACjBlB,2BAAOkB,IAAIC,MAAX;AACH;AAVc,aAAnB;AAYH,SAbM,CAAP;AAcH;;AAED,aAASyB,GAAT,CAAaC,OAAb,EAAsBC,KAAtB,EAA6B;AACzB,eAAO,IAAIhD,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCM,cAAEC,IAAF,CAAOnB,GAAP,EAAY;AACRqB,sBAAM,MADE;AAERrB,qBAAKA,GAFG;AAGRsB,sBAAM;AACFC,4BAAQ,KADN;AAEFkC,6BAASrB,KAAKC,SAAL,CAAeoB,OAAf,CAFP;AAGFC,2BAAOA;AAHL,iBAHE;AAQR7C,0BAAUZ,QAAQa,SARV;AASRC,0BAAUb,QAAQY,SATV;AAURE,yBAAS,UAASQ,GAAT,EAAc;AACnBb,4BAAQa,GAAR;AACH,iBAZO;AAaRP,uBAAO,UAASa,GAAT,EAAc;AACjBlB,2BAAOkB,IAAIC,MAAX;AACH,iBAfO;AAgBRC,0BAAU;AAhBF,aAAZ;AAkBH,SAnBM,CAAP;AAoBH;;AAED,QAAI2B,MAAM;AACNvC,mBAAWA,SADL;AAENa,kBAAUA,QAFJ;AAGNS,mBAAWA,SAHL;AAINQ,oBAAYA,UAJN;AAKNC,mBAAWA,SALL;AAMNE,qBAAaA,WANP;AAONC,qBAAaA,WAPP;AAQNM,yBAAiB,YAAW;AACxB,mBAAOrD,YAAP;AACH,SAVK;AAWNiD,aAAKA;AAXC,KAAV;;AAcAlD,cAAUT,aAAa8D,GAAb,EAAkB,IAAlB,CAAV;AACA,QAAIxD,IAAJ,EAAU;AACNZ,gBAAQsE,WAAR,CAAoB9D,SAASC,GAAT,CAApB,EAAmCJ,QAAQkE,OAA3C;AACH;;AAED;AACA5C,MAAEC,IAAF,CAAOnB,GAAP,EAAY;AACRqB,cAAM,MADE;AAERR,kBAAUZ,QAAQa,SAFV;AAGRC,kBAAUb,QAAQY,SAHV;AAIRE,iBAAS,UAASM,IAAT,EAAeS,MAAf,EAAuBD,GAAvB,EAA4B;AACjC,gBAAIT,OAAOS,IAAIS,iBAAJ,CAAsB,QAAtB,CAAX;AACA,gBAAIlB,SAAS,MAAb,EAAqB;AACjBjB,uBAAO,MAAP;AACA,oBAAI2D,WAAW/D,IAAI0B,KAAJ,CAAU,GAAV,CAAf;AACArB,mCAAmB,MAAM0D,SAASA,SAASnC,MAAT,GAAkB,CAA3B,CAAzB;AACA5B,sBAAM+D,SAASC,KAAT,CAAe,CAAf,EAAkBD,SAASnC,MAAT,GAAkB,CAApC,EAAuCqC,IAAvC,CAA4C,GAA5C,CAAN;AACAC,wBAAQC,GAAR,CAAY,WAAZ,EAAyB9D,gBAAzB,EAA2CL,GAA3C;AACH;;AAEDkE,oBAAQC,GAAR,CAAY,aAAZ,EAA2B/D,IAA3B;AACH,SAfO;AAgBRa,eAAO,UAASa,GAAT,EAAc;AACjBoC,oBAAQjD,KAAR,CAAca,GAAd;AACH;AAlBO,KAAZ;;AAqBAtB,iBAAa;AACTa,cAAM,MADG;AAETrB,aAAKA,GAFI;AAGTsB,cAAM;AACFC,oBAAQ;AADN,SAHG;AAMTS,kBAAU;AAND,KAAb,EAOGoC,IAPH,CAOQ,UAASC,MAAT,EAAiB;AACrB9D,uBAAe8D,MAAf;AACH,KATD;;AAWA,WAAOV,GAAP;AACH,CA7OD","file":"web.js","sourcesContent":["'use strict';\n\n// TODO: fix this fs\nconst history = require('../history');\n\nmodule.exports = function plugin(options) {\n    var poll_watcher = require(\"./poll_watcher\");\n    var fsUtil = require(\"./util\");\n    var niceName = require(\"../lib/url_extractor\").niceName;\n\n    var url = options.url;\n    var user = options.user;\n    var pass = options.pass;\n    var keep = options.keep;\n\n    var mode = \"directory\"; // or: file\n    var fileModeFilename; // if mode === \"file\"\n    var watcher;\n    var capabilities = {};\n\n    function promisedAjax(obj) {\n        return new Promise(function(resolve, reject) {\n            obj.username = user || undefined;\n            obj.password = pass || undefined;\n            obj.success = resolve;\n            obj.error = reject;\n            $.ajax(obj);\n        });\n    }\n\n    function listFiles() {\n        return new Promise(function(resolve, reject) {\n            if (mode === \"file\") {\n                return resolve([fileModeFilename]);\n            }\n            $.ajax({\n                type: \"POST\",\n                url: url,\n                data: {\n                    action: 'filelist'\n                },\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(res) {\n                    var items = res.split(\"\\n\");\n                    for (var i = 0; i < items.length; i++) {\n                        if (!items[i]) {\n                            items.splice(i, 1);\n                            i--;\n                        }\n                    }\n                    resolve(items);\n                },\n                error: function(xhr) {\n                    reject(xhr.status);\n                },\n                dataType: \"text\"\n            });\n        });\n    }\n\n    function readFile(path, binary) {\n        if (mode === \"file\") {\n            if (path === \"/.zedstate\") {\n                return Promise.resolve(JSON.stringify({\n                    \"session.current\": [fileModeFilename]\n                }));\n            }\n            if (path !== fileModeFilename) {\n                return Promise.reject(404);\n            }\n        }\n        return new Promise(function(resolve, reject) {\n            $.ajax({\n                type: \"GET\",\n                url: url + path,\n                username: user || undefined,\n                password: pass || undefined,\n                error: function(xhr) {\n                    reject(xhr.status);\n                },\n                success: function(res, status, xhr) {\n                    watcher.setCacheTag(path, xhr.getResponseHeader(\"ETag\"));\n                    if(binary) {\n                        res = fsUtil.uint8ArrayToBinaryString(new Uint8Array(res));\n                    }\n                    resolve(res);\n                },\n                dataType: binary ? \"arraybuffer\" : \"text\"\n            });\n        });\n    }\n\n    function writeFile(path, content, binary) {\n        if (mode === \"file\") {\n            // Ignore state saves\n            if (path === \"/.zedstate\") {\n                return Promise.resolve();\n            }\n            if (path !== fileModeFilename) {\n                return Promise.reject(500);\n            }\n        }\n        watcher.lockFile(path);\n        return new Promise(function(resolve, reject) {\n            $.ajax(url + path, {\n                type: 'PUT',\n                data: binary ? fsUtil.binaryStringAsUint8Array(content) : content,\n                // dataType: 'text',\n                contentType: 'application/octet-stream',\n                processData: false,\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(res, status, xhr) {\n                    watcher.setCacheTag(path, xhr.getResponseHeader(\"ETag\"));\n                    watcher.unlockFile(path);\n                    resolve(res);\n                },\n                error: function(xhr) {\n                    watcher.unlockFile(path);\n                    reject(xhr.status || xhr.statusText);\n                }\n            });\n        });\n    }\n\n    function deleteFile(path) {\n        return new Promise(function(resolve, reject) {\n            $.ajax(url + path, {\n                type: 'DELETE',\n                dataType: 'text',\n                success: reject,\n                username: user || undefined,\n                password: pass || undefined,\n                error: function(xhr) {\n                    resolve(xhr.status);\n                }\n            });\n        });\n    }\n\n    function watchFile(path, callback) {\n        watcher.watchFile(path, callback);\n    }\n\n    function unwatchFile(path, callback) {\n        watcher.unwatchFile(path, callback);\n    }\n\n    function getCacheTag(path) {\n        return new Promise(function(resolve, reject) {\n            $.ajax(url + path, {\n                type: 'HEAD',\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(data, status, xhr) {\n                    var newEtag = xhr.getResponseHeader(\"ETag\");\n                    resolve(newEtag);\n                },\n                error: function(xhr) {\n                    reject(xhr.status);\n                }\n            });\n        });\n    }\n\n    function run(command, stdin) {\n        return new Promise(function(resolve, reject) {\n            $.ajax(url, {\n                type: \"POST\",\n                url: url,\n                data: {\n                    action: 'run',\n                    command: JSON.stringify(command),\n                    stdin: stdin\n                },\n                username: user || undefined,\n                password: pass || undefined,\n                success: function(res) {\n                    resolve(res);\n                },\n                error: function(xhr) {\n                    reject(xhr.status);\n                },\n                dataType: \"text\"\n            });\n        });\n    }\n\n    var api = {\n        listFiles: listFiles,\n        readFile: readFile,\n        writeFile: writeFile,\n        deleteFile: deleteFile,\n        watchFile: watchFile,\n        unwatchFile: unwatchFile,\n        getCacheTag: getCacheTag,\n        getCapabilities: function() {\n            return capabilities;\n        },\n        run: run\n    };\n\n    watcher = poll_watcher(api, 5000);\n    if (keep) {\n        history.pushProject(niceName(url), options.fullUrl);\n    }\n\n    // Check if we're dealing with one file\n    $.ajax(url, {\n        type: 'HEAD',\n        username: user || undefined,\n        password: pass || undefined,\n        success: function(data, status, xhr) {\n            var type = xhr.getResponseHeader(\"X-Type\");\n            if (type === \"file\") {\n                mode = \"file\";\n                var urlParts = url.split('/');\n                fileModeFilename = \"/\" + urlParts[urlParts.length - 1];\n                url = urlParts.slice(0, urlParts.length - 1).join(\"/\");\n                console.log(\"File mode\", fileModeFilename, url);\n            }\n\n            console.log(\"WebFS mode:\", mode);\n        },\n        error: function(xhr) {\n            console.error(xhr);\n        }\n    });\n\n    promisedAjax({\n        type: 'POST',\n        url: url,\n        data: {\n            action: 'capabilities'\n        },\n        dataType: 'json'\n    }).then(function(result) {\n        capabilities = result;\n    });\n\n    return api;\n};\n"]}