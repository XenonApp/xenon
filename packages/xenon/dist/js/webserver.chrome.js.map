{"version":3,"sources":["../../src/js/webserver.chrome.js"],"names":["module","exports","fsUtil","require","STATUS_CODES","HttpServer","host","port","requestHandler","$$onAccept","$onAccept","bind","prototype","start","server","Promise","resolve","reject","chrome","socket","create","_socketInfo","$socketInfo","listen","socketId","result","accept","console","log","stop","destroy","acceptInfo","$readFromSocket","read","readInfo","data","arrayBufferToString","spaceIndex","indexOf","method","substring","uriEnd","uri","parts","split","headerPart","headers","slice","forEach","headerLine","length","body","request","HttpRequest","response","HttpResponse","err","error","message","stack","requestUri","query","q","path","queryString","part","spl","decodeURIComponent","$status","$server","set","header","value","status","code","send","responseString","headerBuffer","binaryStringAsUint8Array","outputBuffer","ArrayBuffer","byteLength","view","Uint8Array","write","writeInfo","buffer","uint8ArrayToBinaryString"],"mappings":";;AAAA;;;AAGAA,OAAOC,OAAP,GAAiB,YAAW;AACxB,QAAIC,SAASC,QAAQ,WAAR,CAAb;;AAEA,QAAIC,eAAe;AACf,aAAK,UADU;AAEf,aAAK,qBAFU;AAGf,aAAK,YAHU,EAGI;AACnB,aAAK,IAJU;AAKf,aAAK,SALU;AAMf,aAAK,UANU;AAOf,aAAK,+BAPU;AAQf,aAAK,YARU;AASf,aAAK,eATU;AAUf,aAAK,iBAVU;AAWf,aAAK,cAXU,EAWM;AACrB,aAAK,kBAZU;AAaf,aAAK,mBAbU;AAcf,aAAK,mBAdU;AAef,aAAK,WAfU;AAgBf,aAAK,cAhBU;AAiBf,aAAK,WAjBU;AAkBf,aAAK,oBAlBU;AAmBf,aAAK,oBAnBU,EAmBY;AAC3B,aAAK,aApBU;AAqBf,aAAK,cArBU;AAsBf,aAAK,kBAtBU;AAuBf,aAAK,WAvBU;AAwBf,aAAK,WAxBU;AAyBf,aAAK,oBAzBU;AA0Bf,aAAK,gBA1BU;AA2Bf,aAAK,+BA3BU;AA4Bf,aAAK,kBA5BU;AA6Bf,aAAK,UA7BU;AA8Bf,aAAK,MA9BU;AA+Bf,aAAK,iBA/BU;AAgCf,aAAK,qBAhCU;AAiCf,aAAK,0BAjCU;AAkCf,aAAK,uBAlCU;AAmCf,aAAK,wBAnCU;AAoCf,aAAK,iCApCU;AAqCf,aAAK,oBArCU;AAsCf,aAAK,eAtCU,EAsCO;AACtB,aAAK,sBAvCU,EAuCc;AAC7B,aAAK,QAxCU,EAwCA;AACf,aAAK,mBAzCU,EAyCW;AAC1B,aAAK,sBA1CU,EA0Cc;AAC7B,aAAK,kBA3CU,EA2CU;AACzB,aAAK,uBA5CU,EA4Ce;AAC9B,aAAK,mBA7CU,EA6CW;AAC1B,aAAK,iCA9CU,EA8CyB;AACxC,aAAK,uBA/CU;AAgDf,aAAK,iBAhDU;AAiDf,aAAK,aAjDU;AAkDf,aAAK,qBAlDU;AAmDf,aAAK,kBAnDU;AAoDf,aAAK,4BApDU;AAqDf,aAAK,yBArDU,EAqDiB;AAChC,aAAK,sBAtDU,EAsDc;AAC7B,aAAK,0BAvDU;AAwDf,aAAK,cAxDU,EAwDM;AACrB,aAAK,iCAzDU,CAyDwB;AAzDxB,KAAnB;;AA4DA,aAASC,UAAT,CAAoBC,IAApB,EAA0BC,IAA1B,EAAgCC,cAAhC,EAAgD;AAC5C,aAAKA,cAAL,GAAsBA,cAAtB;AACA,aAAKF,IAAL,GAAYA,IAAZ;AACA,aAAKC,IAAL,GAAYA,IAAZ;;AAEA;AACA,aAAKE,UAAL,GAAkB,KAAKC,SAAL,CAAeC,IAAf,CAAoB,IAApB,CAAlB;AACH;;AAEDN,eAAWO,SAAX,GAAuB;AACnBC,eAAO,YAAW;AACd,gBAAIC,SAAS,IAAb;AACA,mBAAO,IAAIC,OAAJ,CAAY,UAASC,OAAT,EAAkBC,MAAlB,EAA0B;AACzCC,uBAAOC,MAAP,CAAcC,MAAd,CAAqB,KAArB,EAA4B,EAA5B,EAAgC,UAASC,WAAT,EAAsB;AAClDP,2BAAOQ,WAAP,GAAqBD,WAArB;AACAH,2BAAOC,MAAP,CAAcI,MAAd,CAAqBT,OAAOQ,WAAP,CAAmBE,QAAxC,EAAkDV,OAAOR,IAAP,IAAe,WAAjE,EAA8EQ,OAAOP,IAArF,EAA2F,EAA3F,EAA+F,UAASkB,MAAT,EAAiB;AAC5G,4BAAIA,WAAW,CAAf,EAAkB;AACd;AACA,mCAAOR,OAAOQ,MAAP,CAAP;AACH;AACDP,+BAAOC,MAAP,CAAcO,MAAd,CAAqBZ,OAAOQ,WAAP,CAAmBE,QAAxC,EAAkDV,OAAOL,UAAzD;AACAkB,gCAAQC,GAAR,CAAY,0BAAZ,EAAwCd,OAAOP,IAA/C;AACAS;AACH,qBARD;AASH,iBAXD;AAYH,aAbM,CAAP;AAcH,SAjBkB;AAkBnBa,cAAM,YAAW;AACb,gBAAI,KAAKP,WAAT,EAAsB;AAClBJ,uBAAOC,MAAP,CAAcW,OAAd,CAAsB,KAAKR,WAAL,CAAiBE,QAAvC;AACA,qBAAKF,WAAL,GAAmB,IAAnB;AACH;AACJ,SAvBkB;AAwBnBZ,mBAAW,UAASqB,UAAT,EAAqB;AAC5B,iBAAKC,eAAL,CAAqBD,WAAWP,QAAhC;AACA;AACAN,mBAAOC,MAAP,CAAcO,MAAd,CAAqB,KAAKJ,WAAL,CAAiBE,QAAtC,EAAgD,KAAKf,UAArD;AACH,SA5BkB;AA6BnBuB,yBAAiB,UAASR,QAAT,EAAmB;AAChC,gBAAIV,SAAS,IAAb;AACAI,mBAAOC,MAAP,CAAcc,IAAd,CAAmBT,QAAnB,EAA6B,UAASU,QAAT,EAAmB;AAC5C,oBAAIC,OAAOC,oBAAoBF,SAASC,IAA7B,CAAX;AACA,oBAAI;AACA,wBAAIE,aAAaF,KAAKG,OAAL,CAAa,GAAb,CAAjB;AACA,wBAAIC,SAASJ,KAAKK,SAAL,CAAe,CAAf,EAAkBH,UAAlB,CAAb;AACA;AACA,wBAAII,SAASN,KAAKG,OAAL,CAAa,GAAb,EAAkBD,aAAa,CAA/B,CAAb;AACA,wBAAII,SAAS,CAAb,EAAgB;AAAE;AACd;AACH;AACD,wBAAIC,MAAMP,KAAKK,SAAL,CAAeH,aAAa,CAA5B,EAA+BI,MAA/B,CAAV;;AAEA,wBAAIE,QAAQR,KAAKS,KAAL,CAAW,YAAX,CAAZ;AACA,wBAAIC,aAAaF,MAAM,CAAN,CAAjB;AACA,wBAAIG,UAAU,EAAd;AACAD,+BAAWD,KAAX,CAAiB,OAAjB,EAA0BG,KAA1B,CAAgC,CAAhC,EAAmCC,OAAnC,CAA2C,UAASC,UAAT,EAAqB;AAC5D,4BAAIN,QAAQM,WAAWL,KAAX,CAAiB,GAAjB,CAAZ;AACA,4BAAID,MAAMO,MAAN,KAAiB,CAArB,EAAwB;AACpBJ,oCAAQH,MAAM,CAAN,CAAR,IAAoBA,MAAM,CAAN,CAApB;AACH;AACJ,qBALD;AAMA,wBAAIQ,OAAOR,MAAM,CAAN,CAAX;;AAEA,wBAAIS,UAAU,IAAIC,WAAJ,CAAgBd,MAAhB,EAAwBG,GAAxB,EAA6BI,OAA7B,EAAsCK,IAAtC,CAAd;AACA,wBAAIG,WAAW,IAAIC,YAAJ,CAAiBzC,MAAjB,EAAyBU,QAAzB,CAAf;AACAV,2BAAON,cAAP,CAAsB4C,OAAtB,EAA+BE,QAA/B;AACH,iBAxBD,CAwBE,OAAOE,GAAP,EAAY;AACV7B,4BAAQ8B,KAAR,CAAc,oBAAd,EAAoCD,IAAIE,OAAxC,EAAiDF,IAAIG,KAArD;AACH;AACJ,aA7BD;AA8BH;AA7DkB,KAAvB;;AAgEA,aAASN,WAAT,CAAqBd,MAArB,EAA6BqB,UAA7B,EAAyCd,OAAzC,EAAkDK,IAAlD,EAAwD;AACpD,YAAIC,UAAU,IAAd;AACA,aAAKb,MAAL,GAAcA,MAAd;AACA,aAAKO,OAAL,GAAeA,OAAf;AACA,aAAKK,IAAL,GAAYA,IAAZ;AACA,aAAKU,KAAL,GAAa,EAAb;;AAEA,YAAIC,IAAIF,WAAWtB,OAAX,CAAmB,GAAnB,CAAR;AACA,YAAIwB,MAAM,CAAC,CAAX,EAAc;AACV,iBAAKC,IAAL,GAAYH,WAAWpB,SAAX,CAAqB,CAArB,EAAwBsB,CAAxB,CAAZ;AACA,gBAAIE,cAAcJ,WAAWpB,SAAX,CAAqBsB,IAAI,CAAzB,CAAlB;AACAE,wBAAYpB,KAAZ,CAAkB,GAAlB,EAAuBI,OAAvB,CAA+B,UAASiB,IAAT,EAAe;AAC1C,oBAAIC,MAAMD,KAAKrB,KAAL,CAAW,GAAX,CAAV;AACAQ,wBAAQS,KAAR,CAAcK,IAAI,CAAJ,CAAd,IAAwBC,mBAAmBD,IAAI,CAAJ,CAAnB,CAAxB;AACH,aAHD;AAIH,SAPD,MAOO;AACH,iBAAKH,IAAL,GAAYH,UAAZ;AACH;AAGJ;;AAED,aAASL,YAAT,CAAsBzC,MAAtB,EAA8BU,QAA9B,EAAwC;AACpC,aAAKA,QAAL,GAAgBA,QAAhB;AACA,aAAK4C,OAAL,GAAe,GAAf;AACA,aAAKtB,OAAL,GAAe,EAAf;AACA,aAAKuB,OAAL,GAAevD,MAAf;AACH;;AAEDyC,iBAAa3C,SAAb,GAAyB;AACrB0D,aAAK,UAASC,MAAT,EAAiBC,KAAjB,EAAwB;AACzB,iBAAK1B,OAAL,CAAayB,MAAb,IAAuBC,KAAvB;AACH,SAHoB;AAIrBC,gBAAQ,UAASC,IAAT,EAAe;AACnB,iBAAKN,OAAL,GAAeM,IAAf;AACH,SANoB;AAOrBC,cAAM,UAASxC,IAAT,EAAe;AACjB,gBAAImB,WAAW,IAAf;AACA,gBAAIsB,iBAAiB,cAAc,KAAKR,OAAnB,GAA6B,GAA7B,GAAmChE,aAAa,KAAKgE,OAAlB,CAAnC,GAAgE,IAArF;AACA,iBAAKtB,OAAL,CAAa,gBAAb,IAAiCX,KAAKe,MAAtC;AACA,iBAAK,IAAIqB,MAAT,IAAmB,KAAKzB,OAAxB,EAAiC;AAC7B8B,kCAAkBL,SAAS,IAAT,GAAgB,KAAKzB,OAAL,CAAayB,MAAb,CAAhB,GAAuC,IAAzD;AACH;AACDK,8BAAkB,IAAlB;;AAEA,gBAAIC,eAAe3E,OAAO4E,wBAAP,CAAgCF,cAAhC,CAAnB;AACA,gBAAIG,eAAe,IAAIC,WAAJ,CAAgBH,aAAaI,UAAb,GAA0B9C,KAAKe,MAA/C,CAAnB;AACA,gBAAIgC,OAAO,IAAIC,UAAJ,CAAeJ,YAAf,CAAX;AACAG,iBAAKZ,GAAL,CAASO,YAAT,EAAuB,CAAvB;AACAK,iBAAKZ,GAAL,CAASpE,OAAO4E,wBAAP,CAAgC3C,IAAhC,CAAT,EAAgD0C,aAAaI,UAA7D;;AAEA/D,mBAAOC,MAAP,CAAciE,KAAd,CAAoB9B,SAAS9B,QAA7B,EAAuCuD,YAAvC,EAAqD,UAASM,SAAT,EAAoB;AACrE;AACAnE,uBAAOC,MAAP,CAAcW,OAAd,CAAsBwB,SAAS9B,QAA/B;AACH,aAHD;AAIH;AA1BoB,KAAzB;;AA6BA,aAASY,mBAAT,CAA6BkD,MAA7B,EAAqC;AACjC,eAAOpF,OAAOqF,wBAAP,CAAgC,IAAIJ,UAAJ,CAAeG,MAAf,CAAhC,CAAP;AACH;;AAED,WAAO;AACHjF,oBAAYA;AADT,KAAP;AAGH,CAzMD","file":"webserver.chrome.js","sourcesContent":["/**\n * Implements a web server in Chrome\n */\nmodule.exports = function() {\n    var fsUtil = require(\"./fs/util\");\n\n    var STATUS_CODES = {\n        100: 'Continue',\n        101: 'Switching Protocols',\n        102: 'Processing', // RFC 2518, obsoleted by RFC 4918\n        200: 'OK',\n        201: 'Created',\n        202: 'Accepted',\n        203: 'Non-Authoritative Information',\n        204: 'No Content',\n        205: 'Reset Content',\n        206: 'Partial Content',\n        207: 'Multi-Status', // RFC 4918\n        300: 'Multiple Choices',\n        301: 'Moved Permanently',\n        302: 'Moved Temporarily',\n        303: 'See Other',\n        304: 'Not Modified',\n        305: 'Use Proxy',\n        307: 'Temporary Redirect',\n        308: 'Permanent Redirect', // RFC 7238\n        400: 'Bad Request',\n        401: 'Unauthorized',\n        402: 'Payment Required',\n        403: 'Forbidden',\n        404: 'Not Found',\n        405: 'Method Not Allowed',\n        406: 'Not Acceptable',\n        407: 'Proxy Authentication Required',\n        408: 'Request Time-out',\n        409: 'Conflict',\n        410: 'Gone',\n        411: 'Length Required',\n        412: 'Precondition Failed',\n        413: 'Request Entity Too Large',\n        414: 'Request-URI Too Large',\n        415: 'Unsupported Media Type',\n        416: 'Requested Range Not Satisfiable',\n        417: 'Expectation Failed',\n        418: 'I\\'m a teapot', // RFC 2324\n        422: 'Unprocessable Entity', // RFC 4918\n        423: 'Locked', // RFC 4918\n        424: 'Failed Dependency', // RFC 4918\n        425: 'Unordered Collection', // RFC 4918\n        426: 'Upgrade Required', // RFC 2817\n        428: 'Precondition Required', // RFC 6585\n        429: 'Too Many Requests', // RFC 6585\n        431: 'Request Header Fields Too Large', // RFC 6585\n        500: 'Internal Server Error',\n        501: 'Not Implemented',\n        502: 'Bad Gateway',\n        503: 'Service Unavailable',\n        504: 'Gateway Time-out',\n        505: 'HTTP Version Not Supported',\n        506: 'Variant Also Negotiates', // RFC 2295\n        507: 'Insufficient Storage', // RFC 4918\n        509: 'Bandwidth Limit Exceeded',\n        510: 'Not Extended', // RFC 2774\n        511: 'Network Authentication Required' // RFC 6585\n    };\n\n    function HttpServer(host, port, requestHandler) {\n        this.requestHandler = requestHandler;\n        this.host = host;\n        this.port = port;\n\n        // bound version of $onAccept\n        this.$$onAccept = this.$onAccept.bind(this);\n    }\n\n    HttpServer.prototype = {\n        start: function() {\n            var server = this;\n            return new Promise(function(resolve, reject) {\n                chrome.socket.create(\"tcp\", {}, function(_socketInfo) {\n                    server.$socketInfo = _socketInfo;\n                    chrome.socket.listen(server.$socketInfo.socketId, server.host || \"127.0.0.1\", server.port, 50, function(result) {\n                        if (result !== 0) {\n                            // Port not available, probably try the next one\n                            return reject(result);\n                        }\n                        chrome.socket.accept(server.$socketInfo.socketId, server.$$onAccept);\n                        console.log(\"Server listening on port\", server.port);\n                        resolve();\n                    });\n                });\n            });\n        },\n        stop: function() {\n            if (this.$socketInfo) {\n                chrome.socket.destroy(this.$socketInfo.socketId);\n                this.$socketInfo = null;\n            }\n        },\n        $onAccept: function(acceptInfo) {\n            this.$readFromSocket(acceptInfo.socketId);\n            // Immediately accept next request\n            chrome.socket.accept(this.$socketInfo.socketId, this.$$onAccept);\n        },\n        $readFromSocket: function(socketId) {\n            var server = this;\n            chrome.socket.read(socketId, function(readInfo) {\n                var data = arrayBufferToString(readInfo.data);\n                try {\n                    var spaceIndex = data.indexOf(\" \");\n                    var method = data.substring(0, spaceIndex);\n                    // we can only deal with GET requests\n                    var uriEnd = data.indexOf(\" \", spaceIndex + 1);\n                    if (uriEnd < 0) { /* throw a wobbler */\n                        return;\n                    }\n                    var uri = data.substring(spaceIndex + 1, uriEnd);\n\n                    var parts = data.split(/\\n\\r?\\n\\r?/);\n                    var headerPart = parts[0];\n                    var headers = {};\n                    headerPart.split(/\\n\\r?/).slice(1).forEach(function(headerLine) {\n                        var parts = headerLine.split(':');\n                        if (parts.length === 2) {\n                            headers[parts[0]] = parts[1];\n                        }\n                    });\n                    var body = parts[1];\n\n                    var request = new HttpRequest(method, uri, headers, body);\n                    var response = new HttpResponse(server, socketId);\n                    server.requestHandler(request, response);\n                } catch (err) {\n                    console.error(\"Exception occurred\", err.message, err.stack);\n                }\n            });\n        }\n    };\n\n    function HttpRequest(method, requestUri, headers, body) {\n        var request = this;\n        this.method = method;\n        this.headers = headers;\n        this.body = body;\n        this.query = {};\n\n        var q = requestUri.indexOf(\"?\");\n        if (q !== -1) {\n            this.path = requestUri.substring(0, q);\n            var queryString = requestUri.substring(q + 1);\n            queryString.split(\"&\").forEach(function(part) {\n                var spl = part.split('=');\n                request.query[spl[0]] = decodeURIComponent(spl[1]);\n            });\n        } else {\n            this.path = requestUri;\n        }\n\n\n    }\n\n    function HttpResponse(server, socketId) {\n        this.socketId = socketId;\n        this.$status = 200;\n        this.headers = {};\n        this.$server = server;\n    }\n\n    HttpResponse.prototype = {\n        set: function(header, value) {\n            this.headers[header] = value;\n        },\n        status: function(code) {\n            this.$status = code;\n        },\n        send: function(data) {\n            var response = this;\n            var responseString = \"HTTP/1.0 \" + this.$status + \" \" + STATUS_CODES[this.$status] + \"\\n\";\n            this.headers[\"Content-Length\"] = data.length;\n            for (var header in this.headers) {\n                responseString += header + \": \" + this.headers[header] + \"\\n\";\n            }\n            responseString += \"\\n\";\n\n            var headerBuffer = fsUtil.binaryStringAsUint8Array(responseString);\n            var outputBuffer = new ArrayBuffer(headerBuffer.byteLength + data.length);\n            var view = new Uint8Array(outputBuffer);\n            view.set(headerBuffer, 0);\n            view.set(fsUtil.binaryStringAsUint8Array(data), headerBuffer.byteLength);\n\n            chrome.socket.write(response.socketId, outputBuffer, function(writeInfo) {\n                // console.log(\"WRITE\", writeInfo);\n                chrome.socket.destroy(response.socketId);\n            });\n        }\n    };\n\n    function arrayBufferToString(buffer) {\n        return fsUtil.uint8ArrayToBinaryString(new Uint8Array(buffer));\n    }\n\n    return {\n        HttpServer: HttpServer\n    };\n}\n"]}