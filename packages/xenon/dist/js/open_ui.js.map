{"version":3,"sources":["../../src/js/open_ui.js"],"names":["eventbus","require","history","fs","editor","config","background","xedd","menu","WEBPACK","icons","filterList","version","declare","builtinProjects","name","url","key","section","html","viewEl","headerEl","phraseEl","listEl","closed","api","openInNewWindow","boot","loadConfiguration","then","showOpenUi","enable","getPreference","showMenus","undefined","firstRun","catch","err","console","error","disabled","$","append","find","fadeOutBackground","once","projectList","close","fadeInBackground","remove","css","text","getProjects","projects","length","splice","push","concat","items","map","project","protocolIcon","val","focus","inputEl","resultsEl","list","onSelect","b","storeLocalFolder","notInList","open","bg","selectDirectory","dir","log","openProject","onCancel","isEmpty","getActiveEditor","onDelete","indexOf","removeProject","title","loadProject","Promise","resolve","reject","el","get","change","setPreference","is","click","event","target","parents","removeClass","addClass","mode","data","setTimeout","module","exports"],"mappings":"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","file":"open_ui.js","sourcesContent":["'use strict';\n\nconst eventbus = require('./eventbus');\nconst history = require('./history');\nconst fs = require('./fs');\nconst editor = require('./editor');\nconst config = require('./config');\nconst background = require('./background');\nconst xedd = require('./xedd');\n\nlet menu;\nif (!WEBPACK) {\n    menu = require('./menu');\n}\n\nconst icons = require(\"./lib/icons\");\nconst filterList = require(\"./lib/filter_list\");\n\nvar version = require(\"../../package.json\").version;\n\neventbus.declare(\"urlchanged\");\n\nconst builtinProjects = [{\n    name: \"Local Folder\",\n    url: \"node:\",\n    key: \"L\"\n}, {\n    name: \"Xedd Folder\",\n    url: \"xedd:\",\n    key: \"Z\"\n}, {\n    section: \"Zed\"\n}, {\n    name: \"Configuration\",\n    html: \"Configuration <img class='tool' data-info='set-config-dir' src='./img/edit.png'>\",\n    url: \"nwconfig:\",\n    key: \"C\"\n}, {\n    name: \"Manual\",\n    url: \"manual:\"\n}];\n\nvar viewEl, headerEl, phraseEl, listEl;\n\nvar closed = false;\n\nvar api = {\n    openInNewWindow: false,\n    boot: function() {\n        config.loadConfiguration().then(function() {\n            if (closed) {\n                return;\n            }\n            api.showOpenUi();\n            var enable = config.getPreference(\"enableAnalytics\");\n            var showMenus = config.getPreference(\"showMenus\");\n            if (enable === undefined || showMenus === undefined) {\n                api.firstRun();\n            }\n        }).\n        catch (function(err) {\n            console.error(\"Error booting\", err);\n        });\n    },\n    showOpenUi: function() {\n        if (!WEBPACK) {\n            menu.disabled = true;\n        }\n        viewEl = $(\"<div class='modal-view'><img src='./img/zed-small.png' class='logo'><h1><span class='title'></span><span class='version'>v\" + version + \"</span></h1><input type='text' id='phrase' placeholder='Filter list'><div id='item-list'></div></div>\");\n        $(\"body\").append(viewEl);\n        headerEl = viewEl.find(\"h1 > span.title\");\n        phraseEl = viewEl.find(\"#phrase\");\n        listEl = viewEl.find(\"#item-list\");\n        api.fadeOutBackground();\n        eventbus.once(\"editorloaded\", function() {\n            api.fadeOutBackground();\n        });\n        api.projectList();\n    },\n    close: function() {\n        if (!WEBPACK) {\n            menu.disabled = false;\n        }\n        closed = true;\n        api.fadeInBackground();\n        viewEl && viewEl.remove();\n    },\n    fadeOutBackground: function() {\n        $(\".ace_editor\").css(\"opacity\", 0.3);\n        $(\".pathbar\").css(\"opacity\", 0.3);\n    },\n    fadeInBackground: function() {\n        $(\".ace_editor\").css(\"opacity\", \"\");\n        $(\".pathbar\").css(\"opacity\", \"\");\n    },\n    projectList: function() {\n        headerEl.text(\"Zed\");\n        history.getProjects().then(function(projects) {\n            if (projects.length > 0) {\n                projects.splice(0, 0, {\n                    section: \"Recently Opened\"\n                });\n            }\n            projects.push({\n                section: \"Open\"\n            });\n            projects = projects.concat(builtinProjects);\n\n            var items = projects.map(function(project) {\n                if (project.section) {\n                    return project;\n                }\n                return {\n                    name: project.name,\n                    url: project.url,\n                    html: \"<img src='\" + icons.protocolIcon(project.url) + \"'/>\" + (project.html ? project.html : project.name),\n                    key: project.key\n                };\n            });\n\n            phraseEl.val(\"\");\n            phraseEl.focus();\n            filterList({\n                inputEl: phraseEl,\n                resultsEl: listEl,\n                list: items,\n                onSelect: function(b) {\n                    if (b === \"set-config-dir\") {\n                        api.close();\n                        require(\"./configfs\").storeLocalFolder().then(function() {\n                            api.showOpenUi();\n                        });\n                        return;\n                    }\n                    if (b.notInList) {\n                        api.open(b.name, b.name);\n                        return api.close();\n                    }\n                    switch (b.url) {\n                        case \"node:\":\n                            background.then(bg => bg.selectDirectory()).then(dir => {\n                                api.open(dir, `node:${dir}`);\n                                api.close();\n                            }).catch(() => {\n                                api.projectList();\n                            });\n                            return; // Don't close the UI\n                        case \"xedd:\":\n                            api.xedd().then(function(url) {\n                                console.log(url);\n                                api.showOpenUi();\n                                // if (url) {\n                                    // api.open(niceName(url), url);\n                                // } else {\n                                    // api.showOpenUi();\n                                // }\n                            });\n                            break;\n                        case \"manual:\":\n                            background.then(bg => bg.openProject(\"Manual\", \"manual:\"));\n                            // Using return instead of break to avoid closing\n                            return api.projectList();\n                        default:\n                            api.open(b.name, b.url);\n                    }\n                    api.close();\n                },\n                onCancel: function() {\n                    if (!fs.isEmpty) {\n                        viewEl.remove();\n                        api.fadeInBackground();\n                        editor.getActiveEditor().focus();\n                    } else {\n                        // Otherwise: cancel not allowed!\n                        api.projectList();\n                    }\n                },\n                onDelete: function(b) {\n                    items.splice(items.indexOf(b), 1);\n                    history.removeProject(b.url);\n                }\n            });\n        }).\n        catch (function(err) {\n            console.error(\"Error\", err);\n        });\n    },\n    open: function(title, url) {\n        if (api.openInNewWindow) {\n            background.then(bg => bg.openProject(title, url));\n        } else {\n            background.then(bg => bg.loadProject(title, url));\n        }\n    },\n    firstRun: function() {\n        return new Promise(function(resolve, reject) {\n            var el = $(\"<div class='modal-view'></div>\");\n            $(\"body\").append(el);\n            $.get(\"./firstrun.html\", function(html) {\n                el.html(html);\n                $(\"#enable\").change(function() {\n                    config.setPreference(\"enableAnalytics\", $(\"#enable\").is(\":checked\"));\n                });\n\n                $(\"#menubar\").change(function() {\n                    config.setPreference(\"showMenus\", $(\"#menubar\").is(\":checked\"));\n                });\n\n                $(\"#done\").click(function() {\n                    el.remove();\n                    resolve();\n                });\n\n                $(\"td\").click(function(event) {\n                    var target = $(event.target).parents(\"td\");\n                    $(\"td\").removeClass(\"selected\");\n                    $(target).addClass(\"selected\");\n                    var mode = target.data(\"mode\");\n                    console.log(\"Mode selected\", mode);\n                    switch (mode) {\n                        case \"traditional\":\n                            config.setPreference(\"showMenus\", true);\n                            config.setPreference(\"persistentTree\", true);\n                            break;\n                        case \"chromeless\":\n                            config.setPreference(\"showMenus\", $(\"#menubar\").is(\":checked\"));\n                            config.setPreference(\"persistentTree\", false);\n                            break;\n                        default:\n                            console.log(\"Unknown mode\", mode);\n                    }\n                });\n\n                setTimeout(function() {\n                    config.setPreference(\"enableAnalytics\", true);\n                    config.setPreference(\"showMenus\", false);\n                    config.setPreference(\"persistentTree\", false);\n                }, 1000);\n            });\n        });\n    },\n    xedd: function() {\n        return xedd.open();\n    }\n};\n\nmodule.exports = api;\n"]}