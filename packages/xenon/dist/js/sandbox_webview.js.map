{"version":3,"sources":["../../src/js/sandbox_webview.js"],"names":["debug","requirejs","config","waitSeconds","define","load","name","req","onload","sandboxRequest","then","text","fromText","amdTransformer","err","console","error","absPath","abs","rel","absParts","split","relParts","pop","i","length","concat","slice","join","moduleAbsPath","source","exec","replace","all","q","mod","newMod","indexOf","origin","id","waitingForReply","window","module","call","args","Promise","resolve","reject","postMessage","type","handleApiResponse","event","data","p","replyTo","undefined","result","addEventListener","url","require","fn","message","log","oldLog","oldWarn","warn","oldError","info","oldInfo","noop","filename","lineno","stack","level","oldFn","toLogEntry","s","_","each","arg","isString","JSON5","stringify","arguments"],"mappings":"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","file":"sandbox_webview.js","sourcesContent":["/*global define, sandboxRequest, _*/\nvar debug = false;\n\nrequirejs.config({\n    waitSeconds: 30\n});\n\ndefine(\"configfs\", [], {\n    load: function(name, req, onload, config) {\n        // console.log(\"Request for configfs file\", name);\n        sandboxRequest(\"zed/configfs\", \"readFile\", [name]).then(function(text) {\n            // console.log(\"Sending\", name);\n            onload.fromText(amdTransformer(name, text));\n        }, function(err) {\n            return console.error(\"Error while loading file\", name, err);\n        });\n    }\n});\n\nfunction absPath(abs, rel) {\n    var absParts = abs.split('/');\n    var relParts = rel.split('/');\n    absParts.pop(); // dir\n    for(var i = 0; i < relParts.length; i++) {\n        if(relParts[i] === '.') {\n            continue;\n        }\n        if(relParts[i] === '..') {\n            absParts.pop();\n            continue;\n        }\n        absParts = absParts.concat(relParts.slice(i));\n        break;\n    }\n    return absParts.join('/');\n}\n\n/**\n * This rewrites extension code in two minor ways:\n * - requires are rewritten to all point to configfs!\n * - AMD wrappers are added if they're not already there'\n */\nfunction amdTransformer(moduleAbsPath, source) {\n    // If this source file is not doing funky stuff like overriding require\n    if (!/require\\s*=/.exec(source)) {\n        source = source.replace(/require\\s*\\(([\"'])(.+)[\"']\\)/g, function(all, q, mod) {\n            var newMod = mod;\n            if (mod.indexOf(\"zed/\") === 0) {\n                newMod = \"configfs!/api/\" + mod;\n            } else if (mod.indexOf(\".\") === 0) {\n                newMod = \"configfs!\" + absPath(moduleAbsPath, mod);\n            } else {\n                return all;\n            }\n            return \"require(\" + q + newMod + (/\\.js$/.exec(newMod) ? \"\" : \".js\") + q + \")\";\n        });\n    }\n    // If no AMD wrapper is there yet, add it\n    if (source.indexOf(\"define(function(\") === -1) {\n        source = \"define(function(require, exports, module) {\" + source + \"\\n});\";\n    }\n    return source;\n}\n\nvar source;\nvar origin;\nvar id = 0;\nvar waitingForReply = {};\n\nwindow.sandboxRequest = function(module, call, args) {\n    return new Promise(function(resolve, reject) {\n        id++;\n        waitingForReply[id] = {\n            resolve: resolve,\n            reject: reject\n        };\n        source.postMessage({\n            type: \"request\",\n            id: id,\n            module: module,\n            call: call,\n            args: args\n        }, origin);\n    });\n};\n\nfunction handleApiResponse(event) {\n    var data = event.data;\n    var p = waitingForReply[data.replyTo];\n\n    if (undefined !== data.err && null !== data.err) {\n        p.reject(data.err);\n    } else {\n        p.resolve(data.result);\n    }\n    delete waitingForReply[data.replyTo];\n}\n\nwindow.addEventListener('message', function(event) {\n    var data = event.data;\n    var id = data.id;\n    var url = data.url;\n\n    source = event.source;\n    origin = event.origin;\n    if (data.replyTo) {\n        return handleApiResponse(event);\n    }\n    if (!url) {\n        return;\n    }\n\n    require([url], function(fn) {\n        Promise.resolve(data.data).then(fn).then(function(result) {\n            var message = {\n                replyTo: id,\n                result: result\n            };\n            if (debug) {\n                console.log(message);\n            }\n            event.source.postMessage(message, origin);\n        }, function(err) {\n            var message = {\n                replyTo: id,\n                err: typeof err === \"string\" ? err : err.message\n            };\n            event.source.postMessage(message, origin);\n        });\n    });\n});\n\n// Override console.log etc\nvar oldLog = console.log;\nvar oldWarn = console.warn;\nvar oldError = console.info;\nvar oldInfo = console.info;\nvar noop = function() {};\nwindow.console.log = log(\"log\", oldLog);\nwindow.console.warn = log(\"warn\", oldWarn);\nwindow.console.error = log(\"error\", oldError);\nwindow.console.info = log(\"info\", oldInfo);\n\nwindow.addEventListener(\"error\", function(err) {\n    log(\"error\", noop)(err.message, err.filename, err.lineno, err.stack);\n});\n\n\nfunction log(level, oldFn) {\n    function toLogEntry(args) {\n        var s = '';\n        _.each(args, function(arg) {\n            if (_.isString(arg)) {\n                s += arg;\n            } else {\n                s += JSON5.stringify(arg, null, 2);\n            }\n            s += ' ';\n        });\n        return s;\n    }\n    return function() {\n        oldFn.call(console, toLogEntry(arguments));\n        // sandboxRequest(\"zed/log\", \"log\", [level, Array.prototype.slice.call(arguments, 0)], function() {});\n    };\n}\n"]}