{"version":3,"sources":["../../src/js/tree.js"],"names":["eventbus","require","goto","command","session_manager","editor","config","fs","ignoreActivate","treeVisible","api","buildDirectoryObject","hook","on","updateTree","getPreference","hideTree","declare","list","sep","root","addEntry","path","parts","split","shift","currentDir","i","length","p","lastPart","objToDynaTree","obj","elements","_","each","entry","filename","fullPath","push","title","key","isFolder","children","indexOf","substring","setTimeout","$","remove","edit","getActiveEditor","showTree","getFileCache","go","hide","focus","removeClass","resizeEditors","treeId","onSelect","editorEl","container","treeEl","addClass","lastFocusEl","cancel","focusTree","tree","dynatree","blur","activateKey","getActiveSession","getActiveNode","getRoot","childList","append","onActivate","node","data","onKeydown","event","keyCode","onFocus","keyboard","autoFocus","debugLevel","slice","sort","show","css","offset","top","define","doc","exec","emit","readOnly","module","exports"],"mappings":"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","file":"tree.js","sourcesContent":["\"use strict\";\n\nconst eventbus = require('./eventbus');\nconst goto = require('./goto');\nconst command = require('./command');\nconst session_manager = require('./session_manager');\nconst editor = require('./editor');\nconst config = require('./config');\nconst fs = require('./fs');\n\nvar ignoreActivate = false;\nvar treeVisible = false;\n\nvar api = {\n    buildDirectoryObject: buildDirectoryObject,\n    hook: function() {\n        eventbus.on(\"loadedfilelist\", updateTree);\n        \n        fs.on('add', () => {\n            updateTree();\n        });\n        \n        fs.on('unlink', () => {\n            updateTree();\n        });\n        \n        eventbus.on(\"configchanged\", function() {\n            if (config.getPreference(\"persistentTree\")) {\n                treeVisible = true;\n                updateTree();\n            } else {\n                hideTree();\n            }\n        });\n    }\n};\n\neventbus.declare(\"tree\");\neventbus.declare(\"commandtree\");\n\nfunction buildDirectoryObject(list, sep) {\n    var root = {};\n\n    function addEntry(path) {\n        var parts = path.split(sep);\n        if (parts[0] === '') {\n            parts.shift();\n        }\n        var currentDir = root;\n        for (var i = 0; i < parts.length - 1; i++) {\n            var p = parts[i];\n            if (!currentDir[p]) {\n                currentDir[p] = {};\n            }\n            currentDir = currentDir[p];\n        }\n        var lastPart = parts[parts.length - 1];\n        currentDir[lastPart] = true;\n    }\n\n    for (var i = 0; i < list.length; i++) {\n        addEntry(list[i]);\n    }\n\n    return root;\n}\n\nfunction objToDynaTree(obj, sep, path) {\n    var elements = [];\n    _.each(obj, function(entry, filename) {\n        var fullPath = path + sep + filename;\n        if (entry !== true) {\n            elements.push({\n                title: filename,\n                key: fullPath,\n                isFolder: true,\n                children: objToDynaTree(entry, sep, fullPath)\n            });\n        }\n    });\n    _.each(obj, function(entry, filename) {\n        var fullPath = path + sep + filename;\n        if (fullPath.indexOf(\"zed::\") !== -1) {\n            fullPath = fullPath.substring(1);\n        }\n        if (entry === true) {\n            elements.push({\n                title: filename,\n                key: fullPath\n            });\n        }\n    });\n    return elements;\n}\n\nfunction updateTree() {\n    setTimeout(function() {\n        $(\"#file-tree\").remove();\n        if (treeVisible) {\n            var edit = editor.getActiveEditor();\n            showTree(\"file-tree\", edit, goto.getFileCache(), \"/\", session_manager.go, false);\n        }\n    });\n}\n\nfunction hideTree() {\n    $(\"#file-tree\").hide();\n    if (!require('./open_ui')) {\n        editor.getActiveEditor().focus();\n    }\n    treeVisible = false;\n    $(\"#editor-wrapper-wrapper\").removeClass(\"left-tree\");\n    editor.resizeEditors();\n}\n\n\nfunction showTree(treeId, edit, list, sep, onSelect, focus) {\n    var editorEl = $(edit.container);\n    var treeEl = $(\"#\" + treeId);\n    treeVisible = true;\n\n    $(\"#editor-wrapper-wrapper\").addClass(\"left-tree\");\n    editor.resizeEditors();\n\n    if (focus) {\n        ignoreActivate = true;\n    }\n    var lastFocusEl = null;\n\n    function cancel() {\n        if (!config.getPreference(\"persistentTree\")) {\n            hideTree();\n        }\n        editor.getActiveEditor().focus();\n    }\n\n    function focusTree() {\n        if (!focus) {\n            return;\n        }\n        setTimeout(function() {\n            var tree = treeEl.dynatree(\"getTree\");\n            editor.getActiveEditor().blur();\n            ignoreActivate = true;\n            tree.activateKey(editor.getActiveSession().filename);\n            if (!tree.getActiveNode()) {\n                tree.getRoot().childList[0].focus();\n            }\n            setTimeout(function() {\n                ignoreActivate = false;\n            });\n        }, 100);\n    }\n\n    if (treeEl.length === 0) {\n        $(\"body\").append(\"<div id='\" + treeId + \"' class='tree'>\");\n\n        treeEl = $(\"#\" + treeId);\n        treeEl.dynatree({\n            onActivate: function(node) {\n                if (ignoreActivate) {\n                    return;\n                }\n                if (!node.data.isFolder) {\n                    cancel();\n                    onSelect(node.data.key);\n                    editor.getActiveEditor().focus();\n                }\n            },\n            onKeydown: function(node, event) {\n                if (event.keyCode === 27) {\n                    cancel();\n                }\n            },\n            onFocus: function(node) {\n                lastFocusEl = node;\n            },\n            keyboard: true,\n            autoFocus: true,\n            debugLevel: 0,\n            children: objToDynaTree(buildDirectoryObject(list.slice().sort(), sep), sep, \"\")\n        });\n        focusTree();\n    } else {\n        treeEl.show();\n        focusTree();\n    }\n    treeEl.css(\"top\", (editorEl.offset().top - 22) + \"px\");\n}\n\ncommand.define(\"Navigate:File Tree\", {\n    doc: \"Display the files of the current project in a tree heirarchy.\",\n    exec: function(edit) {\n        eventbus.emit(\"tree\");\n        showTree(\"file-tree\", edit, goto.getFileCache(), \"/\", session_manager.go, true);\n    },\n    readOnly: true\n});\n\nmodule.exports = api;\n"]}