{"version":3,"sources":["../../src/js/session_manager.js"],"names":["ipcRenderer","WEBPACK","require","config","eventbus","editor","state","ui","command","fs","win","Range","global","ace","async","locator","opts","declare","sessions","oldstateJSON","api","specialDocs","hook","waitForEvents","unblockUI","emit","on","modes","_","each","session","setSessionMode","getModeForSession","edit","newSession","prevSession","saveSession","setCloseHandler","getActiveSession","then","close","send","path","console","log","handleChangedFile","newFile","go","getSession","getSessions","deleteSession","setupSave","saveTimer","filename","delta","ignoreChange","dontPersist","clearTimeout","dirty","saveTimeout","getPreference","setTimeout","readOnly","Promise","resolve","saving","writeFile","getValue","err","error","reject","updateState","set","getEditors","map","e","openDocumentList","Object","keys","sort","a","b","sessionA","sessionB","lastUse","openDocuments","slice","forEach","getSessionState","stateJSON","toJSON","save","loadFile","readFile","text","createSession","window","readOnlyFiles","get","indexOf","reloadFile","$prompting","prompt","message","yes","scrollTop","getScrollTop","scrollLeft","getScrollLeft","cursorPos","selection","getCursor","lineCount","getLength","range","getLine","length","replace","clearSelection","moveCursorToPosition","setScrollTop","setScrollLeft","previousSession","getActiveEditor","show","pathParts","split","loc","otherEdit","switchSession","substring","Date","now","jump","sessionStates","all","sessionState","setSessionState","editors","idx","setInterval","blockUI","define","doc","exec","module","exports"],"mappings":"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","file":"session_manager.js","sourcesContent":["\"use strict\";\n/**\n * This module handles all open editor sessions (i.e. all open files, opening them etc.)\n */\n\nlet ipcRenderer;\nif (!WEBPACK) {\n    ipcRenderer = require('electron').ipcRenderer;\n}\n\nconst config = require('./config');\nconst eventbus = require('./eventbus');\nconst editor = require('./editor');\nconst state = require('./state');\nconst ui = require('./ui');\nconst command = require('./command');\nconst fs = require('./fs');\nconst win = require('./window');\n\nvar Range = global.ace.require(\"ace/range\").Range;\nvar async = require(\"./lib/async\");\nvar locator = require(\"./lib/locator\");\nvar opts = require(\"./lib/options\");\n\n\neventbus.declare(\"switchsession\");\neventbus.declare(\"newsession\");\neventbus.declare(\"sessionbeforesave\");\neventbus.declare(\"sessionsaved\");\neventbus.declare(\"sessionchanged\");\neventbus.declare(\"allsessionsloaded\");\neventbus.declare(\"inited\");\n\nvar sessions = {};\n\n// Used to detect changes in editor state\nvar oldstateJSON = null;\n\nvar api = {\n    specialDocs: {}, // {content: ..., mode: ..., readonly: true}\n    hook: function() {\n        async.waitForEvents(eventbus, [\"loadedfilelist\", \"stateloaded\", \"configchanged\"], function() {\n            ui.unblockUI();\n            eventbus.emit(\"inited\");\n        });\n\n        // Modes have been loaded, let's iterate over all to setup the right one\n        eventbus.on(\"modesloaded\", function(modes) {\n            _.each(sessions, function(session) {\n                modes.setSessionMode(session, modes.getModeForSession(session));\n            });\n        });\n\n        eventbus.on(\"switchsession\", function(edit, newSession, prevSession) {\n            saveSession(prevSession);\n        });\n\n        if (WEBPACK) {\n            win.setCloseHandler(function() {\n                saveSession(editor.getActiveSession()).then(function() {\n                    win.close(true);\n                });\n            });\n        } else {\n            ipcRenderer.on('save-session', () => {\n                saveSession(editor.getActiveSession()).then(function() {\n                    ipcRenderer.send('did-save-session');\n                });\n            });\n        }\n\n        fs.on('change', (path) => {\n            console.log('file changed', path);\n            handleChangedFile(path);\n        });\n\n        fs.on('unlink', (path) => {\n            var session = sessions[path];\n            if (!session || !session.newFile) {\n                console.log('file deleted', path);\n                delete sessions[path];\n            }\n        });\n    },\n    saveSession: saveSession,\n    go: go,\n    handleChangedFile: handleChangedFile,\n    getSession: function(path) {\n        return sessions[path] || api.specialDocs[path];\n    },\n    getSessions: function() {\n        return sessions;\n    },\n    deleteSession: function(path) {\n        if (sessions[path]) {\n            delete sessions[path];\n        }\n    }\n};\n\nfunction setupSave(session) {\n    var saveTimer = null;\n    var path = session.filename;\n    session.on('change', function(delta) {\n        if (session.ignoreChange) {\n            return;\n        }\n        eventbus.emit(\"sessionchanged\", session, delta);\n        if(session.dontPersist) {\n            return;\n        }\n        if (saveTimer) {\n            clearTimeout(saveTimer);\n        }\n        session.dirty = true;\n\n        var saveTimeout = config.getPreference(\"saveTimeout\");\n        if (saveTimeout > 0) {\n            saveTimer = setTimeout(function() {\n                saveSession(session);\n            }, saveTimeout);\n        }\n    });\n    sessions[path] = session;\n}\n\nfunction saveSession(session) {\n    var path = session.filename;\n    if (!path || !session.dirty || session.readOnly) {\n        return Promise.resolve();\n    }\n\n    if (session.newFile) {\n        session.newFile = false;\n    }\n    eventbus.emit(\"sessionactivitystarted\", session, \"Saving\");\n    eventbus.emit(\"sessionbeforesave\", session);\n    session.saving = true;\n    return fs.writeFile(path, session.getValue()).then(function() {\n        eventbus.emit(\"sessionactivitycompleted\", session);\n        eventbus.emit(\"sessionsaved\", session);\n        session.dirty = false;\n    }, function(err) {\n        eventbus.emit(\"sessionactivityfailed\", session, \"Failed to save\");\n        console.error(\"Failed to save\", err);\n        return Promise.reject(err);\n    });\n}\n\n// TODO: Move this to state.js?\nfunction updateState() {\n    state.set(\"session.current\", editor.getEditors().map(function(e) {\n        if (e.getSession().dontPersist) {\n            return \"zed::start\";\n        } else {\n            return e.getSession().filename;\n        }\n    }));\n\n    var openDocumentList = Object.keys(sessions);\n\n    openDocumentList.sort(function(a, b) {\n        var sessionA = sessions[a];\n        var sessionB = sessions[b];\n        return sessionB.lastUse - sessionA.lastUse;\n    });\n\n    var openDocuments = {};\n    openDocumentList.slice(0, 25).forEach(function(path) {\n        var session = sessions[path];\n        if (!session.dontPersist) {\n            openDocuments[path] = editor.getSessionState(session);\n        }\n    });\n    state.set(\"session.open\", openDocuments);\n\n    var stateJSON = state.toJSON();\n    if (stateJSON !== oldstateJSON) {\n        state.save();\n    }\n\n    oldstateJSON = stateJSON;\n}\n\nfunction loadFile(path) {\n    return fs.readFile(path).then(function(text) {\n        var session = editor.createSession(path, text);\n        session.readOnly = window.readOnlyFiles && !!window.readOnlyFiles[path];\n        setupSave(session);\n        return session;\n    });\n}\n\n/**\n * Reloads a file when it has been changed on disk (observed by a file watcher)\n */\nfunction handleChangedFile(path) {\n    var session = sessions[path];\n    if (!session) {\n        return;\n    }\n    if (session.saving) {\n        session.saving = false;\n        return;\n    }\n    // Don't do the asking for a reload dance when this is the config project,\n    // or if the preference to automatically revert is set.\n    if ((opts.get(\"url\").indexOf(\"config:\") === 0) || (config.getPreference(\"globalAutoRevert\"))) {\n        return reloadFile();\n    }\n    if (session.$prompting) {\n        // Already showing a prompt\n        return;\n    }\n    session.$prompting = true;\n    ui.prompt({\n        message: \"File '\" + path + \"' changed on disk, reload (Ok) or keep original (Cancel)?\"\n    }).then(function(yes) {\n        session.$prompting = false;\n        if (yes) {\n            reloadFile();\n        } else {\n            // Create backup of changed file on disk\n            return fs.readFile(path).then(function(text) {\n                return fs.writeFile(path + \".bak\", text);\n            }).then(function() {\n                return fs.writeFile(path, session.getValue());\n            }).then(function() {\n                console.log(\"Did not reload file, saved backup of disk-version in\", path + \".bak\");\n            }, function(err) {\n                console.error(\"Could not backup file:\", path, err);\n            });\n        }\n    });\n\n    function reloadFile() {\n        return fs.readFile(path).then(function(text) {\n            session.ignoreChange = true;\n\n            // Save scroll/cursor state\n            var scrollTop = session.getScrollTop();\n            var scrollLeft = session.getScrollLeft();\n            var cursorPos = session.selection.getCursor();\n\n            var lineCount = session.getLength();\n            var range = new Range(0, 0, lineCount, session.getLine(lineCount - 1).length);\n\n            session.replace(range, text);\n\n            // Restore\n            session.selection.clearSelection();\n            session.selection.moveCursorToPosition(cursorPos);\n            session.setScrollTop(scrollTop);\n            session.setScrollLeft(scrollLeft);\n\n            session.ignoreChange = false;\n        }, function(err) {\n            console.error(\"Could not load file:\", path, err);\n            return Promise.reject(err);\n        });\n    }\n}\n\n/**\n * Navigates to a file, openeing it if hasn't been opened yet, switching to\n * it if it's already loaded in memory\n */\nfunction go(path, edit, previousSession) {\n    edit = edit || editor.getActiveEditor();\n    if (!path) {\n        return Promise.reject(\"No path\");\n    }\n\n    if (api.specialDocs[path]) {\n        var session = api.specialDocs[path];\n        show(session);\n        return Promise.resolve(session);\n    }\n    var pathParts = path.split(':');\n    if (pathParts[0] !== \"zed\") {\n        path = pathParts[0];\n        var loc = pathParts[1];\n        if (path[0] !== '/') {\n            // Normalize\n            path = '/' + path;\n        }\n    }\n\n    // See if this session is open in another editor, if so: swap 'em\n    // This is to ensure you only have a file open in one editor at a time\n    editor.getEditors(true).forEach(function(otherEdit) {\n        if(edit === otherEdit) {\n            return;\n        }\n        if(otherEdit.session.filename === path) {\n            editor.switchSession(edit.session, otherEdit);\n        }\n    });\n\n    // Check if somebody is not trying to create a file ending with '/'\n    if (path[path.length - 1] === '/') {\n        eventbus.emit(\"sessionactivityfailed\", previousSession, \"Cannot create files ending with /\");\n        return Promise.reject(\"Cannot create files ending with /\");\n    }\n\n    if (sessions[path]) {\n        return show(sessions[path]);\n    } else if (path.indexOf(\"zed::\") === 0) {\n        var readOnly = true;\n        if(path.indexOf(\"|write\") !== -1) {\n            path = path.substring(0, path.indexOf(\"|write\"));\n            readOnly = false;\n        }\n        var session = editor.createSession(path, \"\");\n        session.readOnly = readOnly;\n        session.dontPersist = true;\n        sessions[path] = session;\n        setupSave(session); // Not really saving, but for listening to change events\n        return show(session);\n    } else {\n        eventbus.emit(\"sessionactivitystarted\", previousSession, \"Loading...\");\n        return loadFile(path).then(function(session) {\n            eventbus.emit(\"sessionactivitycompleted\", previousSession);\n            eventbus.emit(\"newsession\", session);\n            return show(session);\n        }, function(err) {\n            console.log(\"Creating new, empty file\", path);\n            session = editor.createSession(path, \"\");\n            setupSave(session);\n            session.newFile = true;\n            return show(session);\n        });\n    }\n\n    function show(session) {\n        session.lastUse = Date.now();\n        previousSession = previousSession || edit.getSession();\n        editor.switchSession(session, edit);\n\n        if (loc) {\n            setTimeout(function() {\n                locator.jump(loc);\n            });\n        }\n\n        return Promise.resolve(session);\n    }\n}\n\nasync.waitForEvents(eventbus, [\"stateloaded\", \"modesloaded\"], function() {\n    var sessionStates = state.get(\"session.open\") || {};\n\n    go(\"zed::start\");\n\n    Promise.all(Object.keys(sessionStates).map(function(path) {\n        var sessionState = sessionStates[path];\n        return loadFile(path).then(function(session) {\n            editor.setSessionState(session, sessionState);\n        }, function(err) {\n            delete sessionStates[path];\n        });\n    })).then(function() {\n        console.log(\"All sessions loaded.\");\n        var editors = editor.getEditors();\n        if (state.get(\"session.current\")) {\n            state.get(\"session.current\").forEach(function(path, idx) {\n                go(path, editors[idx]);\n            });\n        }\n        eventbus.emit(\"allsessionsloaded\");\n    });\n\n    setInterval(updateState, 2500);\n});\n\nui.blockUI(\"Loading. One moment please...\");\n\ncommand.define(\"File:Reload\", {\n    doc: \"Re-read this file from disk, reverting any unsaved changes.\",\n    exec: function(edit, session) {\n        handleChangedFile(session.filename);\n    },\n    readOnly: true\n});\n\ncommand.define(\"File:Save\", {\n    doc: \"Explicitly saves a file, for those who don't trust auto-save\",\n    exec: function(edit, session) {\n        saveSession(session);\n    },\n    readOnly: true\n});\n\nmodule.exports = api;\n"]}