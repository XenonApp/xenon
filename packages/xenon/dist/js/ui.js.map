{"version":3,"sources":["../../src/js/ui.js"],"names":["eventbus","require","AcePopup","path","keyCode","blockedEl","webviewEl","api","filterBox","options","editor","placeholder","filter","onSelect","selection","inputVal","setTimeout","onChange","onCancel","hint","currentPath","edit","getActiveEditor","editorWrapperEl","$","append","editorEl","container","gotoEl","hintEl","box","input","css","offset","left","width","popup","on","e","select","stop","setData","name","handleSelect","val","getCurrentHighlightedItem","triggerOnChange","updateHint","lastPhrase","results","text","ignoreKeyup","keyup","event","preventDefault","stopPropagation","updateResults","then","keydown","phrase","dirname","shiftKey","go","doTab","cancel","i","caret","start","focus","length","getData","getRow","where","row","max","session","getLength","Math","min","setRow","selectedPath","close","removeListener","hide","remove","html","results_","slice","_","each","result","caption","isOpen","show","top","window","phraseParts","split","indexOf","parts","join","prompt","message","inputText","dialogEl","makeDialog","height","escape","okButton","cancelButton","Promise","resolve","click","ok","buttonWrapEl","undefined","blur","bind","keyHandler","unbind","blockUI","noSpin","unblockUI","showWebview","url","isNodeWebkit","find","attr","addEventListener","hideWebview","round","module","exports"],"mappings":"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","file":"ui.js","sourcesContent":["/*global define, $, _, ace */\n\"use strict\";\n\nconst eventbus = require('./eventbus');\n\nvar AcePopup = require(\"./lib/ace_popup\").AcePopup;\n// var AcePopup = require(\"ace/autocomplete/popup\").AcePopup;\nvar path = require(\"./lib/path\");\nvar keyCode = require(\"./lib/key_code\");\n\nvar blockedEl = null;\nvar webviewEl = null;\n\nvar api = {\n    /**\n     * Supported options\n     * - placeholder\n     * - text (initial text in input)\n     * - currentPath\n     * - filter (function)\n     * - hint (function)\n     * - onSelect (function)\n     * - onCancel (function)\n     */\n    // TODO: Clean up this mess\n    filterBox: function(options) {\n        var editor = require(\"./editor\");\n        var placeholder = options.placeholder || \"\";\n        var filter = options.filter;\n        var onSelect = function(selection, inputVal) {\n            setTimeout(function() {\n                options.onSelect(selection, inputVal);\n            });\n        };\n        var onChange = options.onChange;\n        var onCancel = options.onCancel || function() {};\n        var hint = options.hint;\n        var currentPath = options.currentPath;\n\n        var edit = editor.getActiveEditor();\n        var editorWrapperEl = $(\"#editor-wrapper\");\n        editorWrapperEl.append(\"<div id='goto'><input type='text' id='gotoinput' spellcheck='false' autocomplete='off' placeholder='\" + placeholder + \"'/><div id='gotohint'></div><div id='results'>\");\n\n        var editorEl = $(edit.container);\n        var gotoEl = $(\"#goto\");\n        var hintEl = $(\"#gotohint\");\n        var box = $(\"#goto\");\n        var input = $(\"#gotoinput\");\n\n        gotoEl.css(\"left\", (editorEl.offset().left - editorWrapperEl.offset().left + 40) + \"px\");\n        gotoEl.css(\"width\", (editorEl.width() - 80) + \"px\");\n        var popup = new AcePopup($(\"#results\")[0]);\n        popup.on(\"click\", function(e) {\n            select();\n            e.stop();\n        });\n        // Initialize with some dummy data (works around an ACE bug)\n        popup.setData([{\n            name: \"1\"\n        }, {\n            name: \"2\"\n        }, {\n            name: \"3\"\n        }]);\n\n        var handleSelect = false;\n\n        popup.on(\"select\", function() {\n            if (!handleSelect) {\n                return;\n            }\n            input.val(getCurrentHighlightedItem());\n            triggerOnChange();\n            updateHint();\n        });\n\n        var lastPhrase = null;\n        var results = [];\n\n        if (options.text) {\n            input.val(options.text);\n        }\n\n        var ignoreKeyup = false;\n\n        input.keyup(function(event) {\n            if (ignoreKeyup) {\n                ignoreKeyup = false;\n                event.preventDefault();\n                event.stopPropagation();\n                return;\n            }\n            if (event.keyCode === keyCode('Return')) {\n                select();\n            } else if (lastPhrase != input.val()) {\n                updateResults().then(triggerOnChange);\n            }\n        });\n\n        input.keydown(function(event) {\n            switch (event.keyCode) {\n                case keyCode('Space'):\n                    var phrase = input.val();\n                    if (phrase) {\n                        break;\n                    }\n                    if (currentPath) {\n                        input.val(path.dirname(currentPath) + \"/\");\n                        event.preventDefault();\n                    }\n                    break;\n                case keyCode('Tab'):\n                    // Tab\n                    if (event.shiftKey) {\n                        go('up');\n                    } else {\n                        doTab();\n                    }\n                    event.preventDefault();\n                    event.stopPropagation();\n                    ignoreKeyup = true;\n                    break;\n                case keyCode('Esc'):\n                    cancel();\n                    break;\n                case keyCode('Up'):\n                    go('up');\n                    ignoreKeyup = true;\n                    break;\n                case keyCode('Down'):\n                    go('down');\n                    ignoreKeyup = true;\n                    break;\n                case keyCode('PgUp'):\n                    for (var i = 0; i < 10; i++) {\n                        go('up');\n                    }\n                    ignoreKeyup = true;\n                    break;\n                case keyCode('PgDown'):\n                    for (var i = 0; i < 10; i++) {\n                        go('down');\n                    }\n                    ignoreKeyup = true;\n                    break;\n                case keyCode('Home'):\n                case keyCode('End'):\n                    ignoreKeyup = true;\n                    break;\n                case keyCode('Backspace'):\n                    // backspace\n                    var val = input.val();\n                    var caret = input.caret();\n                    if (val === '/') {\n                        input.val('');\n                    } else if (val[caret.start - 1] === '/') {\n                        input.val(path.dirname(input.val()) + \"/\");\n                        event.preventDefault();\n                    }\n                    break;\n            }\n        });\n        input.focus();\n        updateResults().then(triggerOnChange);\n        eventbus.on(\"splitswitched\", cancel);\n\n\n        function triggerOnChange() {\n            onChange && onChange(input.val(), getCurrentHighlightedItem());\n        }\n\n        function getCurrentHighlightedItem() {\n            if (results.length === 0) {\n                return null;\n            }\n            return popup.getData(popup.getRow()).path;\n        }\n\n        function go(where) {\n            var row = popup.getRow();\n            var max = popup.session.getLength() - 1;\n\n            switch (where) {\n                case \"up\":\n                    row = Math.max(0, row - 1);\n                    break;\n                case \"down\":\n                    row = Math.min(max, row + 1);\n                    break;\n                case \"start\":\n                    row = 0;\n                    break;\n                case \"end\":\n                    row = max;\n                    break;\n            }\n\n            popup.setRow(row);\n        }\n\n        function select(event) {\n            var inputVal = input.val();\n            var selection = inputVal;\n            var selectedPath = getCurrentHighlightedItem();\n            close();\n            if (selection) {\n                if (selection[0] !== '/' && selectedPath) {\n                    selection = selectedPath;\n                }\n                onSelect(selection, inputVal);\n            } else {\n                // By default pick the item at the top of the list\n                if (typeof selectedPath !== 'undefined' && selectedPath !== null) {\n                    onSelect(selectedPath, inputVal);\n                } else {\n                    onCancel();\n                }\n            }\n            event && event.preventDefault();\n        }\n\n        function close() {\n            eventbus.removeListener(\"splitswitched\", cancel);\n            popup.hide();\n            box.remove();\n            editor.getActiveEditor().focus();\n        }\n\n        function updateHint() {\n            if (hint) {\n                hintEl.html(hint(input.val(), results));\n            }\n        }\n\n        function cancel() {\n            onCancel();\n            close();\n        }\n\n        function updateResults() {\n            var phrase = input.val();\n            return filter(phrase).then(function(results_) {\n                results = results_.slice(0, 500);\n                if (results.length > 0) {\n                    _.each(results, function(result) {\n                        result.caption = result.name;\n                    });\n                    handleSelect = false;\n                    if (!popup.isOpen) {\n                        popup.show({\n                            left: 0,\n                            top: 0\n                        }, 14);\n                        $(popup.container).css(\"top\", 0);\n                    }\n                    window.results = results;\n                    popup.setData(results);\n                    handleSelect = true;\n                } else {\n                    popup.hide();\n                }\n                updateHint();\n                lastPhrase = phrase;\n            });\n        }\n        window.popup = popup;\n\n        function doTab() {\n            var phrase = input.val();\n            if (phrase[0] === \"/\") {\n                // We're going to attempt to complete the next path component\n                // here.\n                var phraseParts = phrase.split(\"/\");\n                for (var i = 0; i < results.length; i++) {\n                    var result = results[i];\n                    // If the prefix doesn't match: not interested\n                    if (result.path.indexOf(phrase) !== 0) {\n                        continue;\n                    }\n                    var parts = results[i].path.split(\"/\");\n                    // If the path has 1+ more path components\n                    if (phraseParts.length < parts.length) {\n                        input.val(phraseParts.slice(0, -1).join(\"/\") + \"/\" + parts[phraseParts.length - 1] + \"/\");\n                        updateResults();\n                        return;\n                    }\n                }\n                // No match? Just go down one, as usual\n                go(\"down\");\n            } else {\n                go(\"down\");\n            }\n        }\n\n    },\n    /**\n     * Options\n     * - width\n     * - height\n     * - message\n     * - input (if left undefined there's no input element)\n     */\n    prompt: function(options) {\n        var editor = require(\"./editor\");\n        var message = options.message || \"\";\n        var inputText = options.input;\n        var input;\n\n        var dialogEl = makeDialog(options.width || 300, options.height || 100);\n        dialogEl.html(\"<div>\" + _.escape(message) + \"</div>\");\n        var okButton = $(\"<button>OK</button>\");\n        var cancelButton = $(\"<button>Cancel</button>\");\n\n        return new Promise(function(resolve) {\n            okButton.click(ok);\n            cancelButton.click(cancel);\n\n            var buttonWrapEl = $(\"<div class='buttons'>\");\n            buttonWrapEl.append(okButton);\n            buttonWrapEl.append(cancelButton);\n\n            if (inputText !== undefined) {\n                input = $(\"<input type='text'>\");\n                input.val(inputText);\n                dialogEl.append(input);\n                input.focus();\n                input.select();\n            }\n\n            dialogEl.append(buttonWrapEl);\n\n            editor.getActiveEditor().blur();\n            dialogEl.focus();\n            setTimeout(function() {\n                $(\"body\").bind(\"keyup\", keyHandler);\n            }, 100);\n\n            function keyHandler(event) {\n                switch (event.keyCode) {\n                    case keyCode('Return'):\n                        ok();\n                        break;\n                    case keyCode('Esc'):\n                        cancel();\n                        break;\n                }\n            }\n\n            function ok() {\n                close();\n                resolve(input ? input.val() : true);\n            }\n\n            function cancel() {\n                close();\n                resolve();\n            }\n\n            function close() {\n                dialogEl.remove();\n                editor.getActiveEditor().focus();\n                $(\"body\").unbind(\"keyup\", keyHandler);\n            }\n        });\n\n    },\n    blockUI: function(message, noSpin) {\n        $(\"#blockui\").remove();\n        blockedEl = $(\"<div id='blockui'>\");\n        $(\"body\").append(blockedEl);\n        blockedEl.html(message + (!noSpin ? \" <img src='./icons/Icon.png' id='wait-logo'/>\" : \"\"));\n    },\n    unblockUI: function() {\n        $(\"#blockui\").remove();\n    },\n    showWebview: function(url) {\n        if (webviewEl) {\n            webviewEl.remove();\n        }\n        if (window.isNodeWebkit) {\n            webviewEl = $(\"<div class='webview-wrapper'><iframe nwdisable nwfaketop class='webview'>\");\n        } else {\n            webviewEl = $(\"<div class='webview-wrapper'><webview class='webview'>\");\n        }\n        webviewEl.find(\".webview\").attr(\"src\", url);\n        $(\"#editor-wrapper\").append(webviewEl);\n        webviewEl.find(\".webview\")[0].addEventListener(\"loadstop\", function() {\n            webviewEl.find(\".webview\").focus();\n        });\n    },\n    hideWebview: function() {\n        if (webviewEl) {\n            webviewEl.remove();\n            require(\"./editor\").getActiveEditor().focus();\n        }\n    }\n};\n\nfunction makeDialog(width, height) {\n    var dialogEl = $('<div id=\"dialog\">');\n    dialogEl.css(\"height\", height + \"px\");\n    dialogEl.css(\"margin-top\", -Math.round(height / 2) + \"px\");\n    dialogEl.css(\"width\", width + \"px\");\n    dialogEl.css(\"margin-left\", -Math.round(height / 2) + \"px\");\n\n    $(\"body\").append(dialogEl);\n    return dialogEl;\n}\n\nmodule.exports = api;\n"]}