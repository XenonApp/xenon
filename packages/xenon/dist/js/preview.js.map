{"version":3,"sources":["../../src/js/preview.js"],"names":["path","require","split","resetEditorDiv","switchSplit","state","editor","command","eventbus","nodeFs","WEBPACK","previewWrapperEl","previewEl","previewScrollY","declare","api","hook","on","get","splitState","indexOf","splitPreview","parseInt","substring","length","type","hide","delayedUpdate","init","data","readFileSync","join","__dirname","encoding","window","isNodeWebkit","$","append","attr","showPreview","html","open","inject","contentWindow","postMessage","content","isPreviewing","setTimeout","update","session","getActiveSession","emit","_","debounce","style","undefined","currentSplit","set","addClass","show","editors","getEditors","activeEditor","getActiveEditor","getSession","setSession","forEach","resize","define","doc","exec","readOnly","module","exports"],"mappings":"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","file":"preview.js","sourcesContent":["'use strict';\n/**\n * Implements the preview split mode\n */\n// TODO: Redo all of this, it's messy and buggy\n\nconst path = require('path');\n\nconst split = require('./split');\nconst resetEditorDiv = split.resetEditorDiv;\nconst switchSplit = split.switchSplit;\nconst state = require('./state');\nconst editor = require('./editor');\nconst command = require('./command');\nconst eventbus = require('./eventbus');\n\nlet nodeFs;\nif (!WEBPACK) {\n    nodeFs = require('fs');\n}\n\nvar previewWrapperEl;\nvar previewEl;\nvar previewScrollY = 0;\n\neventbus.declare(\"preview\");\n\nvar api = {\n    hook: function() {\n        eventbus.on(\"allsessionsloaded\", function() {\n            previewScrollY = state.get(\"preview.scrollY\") || 0;\n            var splitState = state.get(\"split\");\n            if (splitState && (\"\" + splitState).indexOf(\"preview-\") === 0) {\n                splitPreview(parseInt(splitState.substring(\"preview-\".length), 10));\n            }\n        });\n        eventbus.on(\"splitchange\", function(type) {\n            if (type.indexOf(\"preview-\") === -1) {\n                // Not a preview split, hide the preview\n                previewWrapperEl.hide();\n            }\n        });\n        eventbus.on(\"sessionchanged\", delayedUpdate);\n        eventbus.on(\"switchsession\", delayedUpdate);\n    },\n    init: function() {\n        let data;\n        if (WEBPACK) {\n            data = require('../preview.html');\n        } else {\n            data = \"data:text/html,\" + nodeFs.readFileSync(path.join(__dirname, '..', \"preview.html\"), {encoding: 'utf-8'});\n        }\n        if(window.isNodeWebkit) {\n            previewWrapperEl = $(\"<div id='preview-wrapper' class='preview-vsplit2-right'><iframe id='preview'>\").hide();\n        } else {\n            previewWrapperEl = $(\"<div id='preview-wrapper' class='preview-vsplit2-right'><webview id='preview'>\").hide();\n        }\n        $(\"#editor-wrapper\").append(previewWrapperEl);\n        previewEl = $(\"#preview\");\n        previewEl.attr(\"src\", data);\n    },\n    showPreview: function(html, open) {\n        function inject() {\n            previewEl[0].contentWindow.postMessage({\n                content: html\n            }, \"*\");\n        }\n\n        if (open && !isPreviewing()) {\n            splitPreview();\n\n            // TODO: Not so nice. Will be removed\n            // when this component receives a refactoring.\n            return setTimeout(inject, 800);\n        }\n\n        inject();\n    },\n};\n\nfunction isPreviewing() {\n    var splitState = state.get(\"split\");\n    return splitState && (\"\" + splitState).indexOf(\"preview-\") === 0;\n}\n\nfunction update() {\n    if (!isPreviewing()) {\n        return;\n    }\n    var session = editor.getActiveSession();\n    eventbus.emit(\"preview\", session);\n}\n\nvar delayedUpdate = _.debounce(update, 500);\n\nfunction splitPreview(style) {\n    if (style === undefined) {\n        var currentSplit = \"\" + state.get(\"split\") || \"\";\n        if (currentSplit.indexOf(\"preview-\") === 0) {\n            // Increase by one\n            style = (parseInt(currentSplit.substring(\"preview-\".length), 10) + 1) % 3;\n        } else {\n            style = 0;\n        }\n    }\n    state.set(\"split\", \"preview-\" + style);\n    resetEditorDiv($(\"#editor0\")).addClass(\"editor-vsplit2-left-\" + style);\n    resetEditorDiv($(\"#editor1\")).addClass(\"editor-disabled\");\n    resetEditorDiv($(\"#editor2\")).addClass(\"editor-disabled\");\n    previewWrapperEl.attr(\"class\", \"preview-vsplit2-right-\" + style);\n    previewWrapperEl.show();\n\n    var editors = editor.getEditors(true);\n    var activeEditor = editor.getActiveEditor();\n    if (editors[0] !== activeEditor) {\n        var session = activeEditor.getSession();\n        activeEditor.setSession(editors[0].getSession());\n        editors[0].setSession(session);\n    }\n\n    editor.getEditors(true).forEach(function(editor) {\n        editor.resize();\n    });\n    switchSplit();\n    eventbus.emit(\"splitchange\", \"preview-\" + style);\n    setTimeout(update, 200);\n}\n\n\n\ncommand.define(\"Split:Preview\", {\n    doc: \"Open a split pane with a preview of the current document.\",\n    exec: function() {\n        splitPreview();\n    },\n    readOnly: true\n});\n\nmodule.exports = api;\n"]}