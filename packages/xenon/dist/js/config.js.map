{"version":3,"sources":["../../src/js/config.js"],"names":["app","WEBPACK","require","remote","JSON5","nodePath","eventbus","command","sandboxes","configfs","background","path","declare","minimumConfiguration","imports","databases","preferences","modes","keys","commands","handlers","window_themes","editor_themes","packages","config","_","extend","userConfig","expandedConfiguration","api","hook","on","loadConfiguration","session","filename","watch","writeUserPrefs","addPackage","name","readFile","then","json","parse","indexOf","push","writeFile","stringify","removePackage","index","splice","getDir","localStorage","configDir","join","getPath","getPreference","key","mode","undefined","setPreference","value","makeUserBackup","togglePreference","newvalue","incrementInteger","amount","getDatabases","getModes","getKeys","getCommands","getPackages","getPreferences","getHandlers","getEditorTheme","getEditorThemes","getWindowTheme","getWindowThemes","getConfiguration","superExtend","dest","source","isArray","removals","newArray","el","i","length","isString","substring","idx","isObject","p","hasOwnProperty","expandConfiguration","setts","importedPackages","forEach","Promise","all","map","imp","promises","text","pkgText","pkg","JSON","addUrlToCommands","main","Object","e","console","error","resolveRelativePaths","err","warn","resolve","cmd","scriptUrl","catch","goto","getFileCache","base","loadUserConfiguration","rootFile","config_","emit","configJson","jsonPath","dir","dirname","each","resolveThemes","themes","theme","css","file","define","doc","exec","readOnly","prompt","message","yes","listFiles","files","deleteFile","log","edit","go","setMode","setValue","bg","openProject","window","isNodeWebkit","defineInputable","module","exports"],"mappings":"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","file":"config.js","sourcesContent":["\"use strict\";\n\n// TODO: fix the config dir\nlet app;\nif (!WEBPACK) {\n    app = require('electron').remote.app;\n}\nconst JSON5 = require('json5');\nconst nodePath = require('path');\n\nconst eventbus = require('./eventbus');\nconst command = require('./command');\n\nconst sandboxes = require('./sandboxes');\nconst configfs = require('./configfs');\nconst background = require('./background');\n\nvar path = require(\"./lib/path\");\n\neventbus.declare(\"configchanged\");\neventbus.declare(\"configneedsreloading\");\n\nrequire(\"./lib/vim_patch\");\n\nvar minimumConfiguration = {\n    imports: [\n        \"/default.json\"],\n    databases: {},\n    preferences: {},\n    modes: {},\n    keys: {},\n    commands: {},\n    handlers: {},\n    window_themes: {},\n    editor_themes: {},\n    packages: []\n};\n\nvar config = _.extend({}, minimumConfiguration);\nvar userConfig = _.extend({}, minimumConfiguration); // Cache of user.json file\n\nvar expandedConfiguration = _.extend({}, config);\n\nvar api = {\n    hook: function() {\n        eventbus.on(\"loadedfilelist\", loadConfiguration);\n        eventbus.on(\"configneedsreloading\", loadConfiguration);\n\n        eventbus.on(\"sessionsaved\", function(session) {\n            if (session.filename === \"/zedconfig.json\") {\n                loadConfiguration();\n            }\n        });\n\n        configfs.watch('node_modules');\n        configfs.on('change', (path) => {\n            if (path === '/user.json') {\n                loadConfiguration();\n            }\n        });\n    },\n    writeUserPrefs: writeUserPrefs,\n    loadConfiguration: loadConfiguration,\n    addPackage(name) {\n        return configfs.readFile(\"/user.json\").then(function(userConfig) {\n            var json = JSON5.parse(userConfig);\n            if (!json.packages) {\n                json.packages = [];\n            }\n            if (json.packages.indexOf(name) === -1) {\n                json.packages.push(name);\n            }\n            return configfs.writeFile(\"/user.json\", JSON5.stringify(json, null, 4));\n        });\n    },\n    removePackage(name) {\n        return configfs.readFile(\"/user.json\").then(function(userConfig) {\n            var json = JSON5.parse(userConfig);\n            if (!json.packages) {\n                return;\n            }\n\n            const index = json.packages.indexOf(name);\n            if (index === -1) {\n                return;\n            }\n\n            json.packages.splice(index, 1);\n            return configfs.writeFile(\"/user.json\", JSON5.stringify(json, null, 4));\n        });\n    },\n    getDir() {\n        return localStorage.configDir || nodePath.join(app.getPath('userData'), 'config');\n    },\n    getPreference: function(key, session) {\n        if (session && session.mode) {\n            var mode = session.mode;\n            if (mode.preferences[key] !== undefined) {\n                return mode.preferences[key];\n            }\n        }\n        return expandedConfiguration.preferences[key];\n    },\n    setPreference: function(key, value) {\n        config.preferences[key] = value;\n        if (!userConfig.preferences) {\n            // If this happens the user.json file contains syntax\n            // mistakes. However it's important to _still_ save this\n            // preference. What we'll do is effectively overwrite the\n            // existing user.json with only preferences, but make\n            // a backup of user.json\n            userConfig.preferences = {};\n            makeUserBackup().then(function() {\n                userConfig.preferences[key] = value;\n                writeUserPrefs();\n            });\n        } else {\n            userConfig.preferences[key] = value;\n            writeUserPrefs();\n        }\n    },\n    togglePreference: function(key, session) {\n        var newvalue = !api.getPreference(key, session);\n        api.setPreference(key, newvalue);\n        return newvalue;\n    },\n    incrementInteger: function(key, amount, session) {\n        var newvalue = api.getPreference(key, session) + amount;\n        api.setPreference(key, newvalue);\n        return newvalue;\n    },\n    getDatabases: function() {\n        return expandedConfiguration.databases;\n    },\n    getModes: function() {\n        return expandedConfiguration.modes;\n    },\n    getKeys: function() {\n        return expandedConfiguration.keys;\n    },\n    getCommands: function() {\n        return expandedConfiguration.commands;\n    },\n    getPackages: function() {\n        return expandedConfiguration.packages;\n    },\n    getPreferences: function() {\n        return expandedConfiguration.preferences;\n    },\n    getHandlers: function() {\n        return expandedConfiguration.handlers;\n    },\n    getEditorTheme: function(name) {\n        return expandedConfiguration.editor_themes[name];\n    },\n    getEditorThemes: function() {\n        return expandedConfiguration.editor_themes;\n    },\n    getWindowTheme: function(name) {\n        return expandedConfiguration.window_themes[name];\n    },\n    getWindowThemes: function() {\n        return expandedConfiguration.window_themes;\n    },\n    getConfiguration: function() {\n        return expandedConfiguration;\n    }\n};\n\n/**\n * This is a super-charged version of _.extend, it recursively merges\n * objects and concatenates arrays (but does not add duplicates).\n * If an array contains a string element starting with \"!\" that element (without !)\n * will be removed from the merged array if present.\n *\n * This function does not modify either dest or source, it creates a new\n * object\n */\nfunction superExtend(dest, source) {\n    if (_.isArray(dest)) {\n        if (!source) {\n            return dest;\n        }\n        var removals = {};\n        var newArray = [];\n        var el, i;\n        for (i = 0; i < dest.length; i++) {\n            el = dest[i];\n            if (_.isString(el) && el[0] === \"!\") {\n                removals[el.substring(1)] = true;\n            } else {\n                newArray.push(el);\n            }\n        }\n        for (i = 0; i < source.length; i++) {\n            el = source[i];\n            if (_.isString(el) && el[0] === \"!\") {\n                var idx = newArray.indexOf(el.substring(1));\n                if (idx !== -1) {\n                    // Remove from newArray\n                    newArray.splice(idx, 1);\n                }\n            } else if (newArray.indexOf(el) === -1 && !removals[el]) {\n                newArray.push(el);\n            }\n        }\n        return newArray;\n    } else if (_.isObject(dest)) {\n        dest = _.extend({}, dest); // shallow clone\n        if (source) {\n            for (var p in source) {\n                if (source.hasOwnProperty(p)) {\n                    if (dest[p] === undefined) {\n                        dest[p] = source[p];\n                    } else {\n                        dest[p] = superExtend(dest[p], source[p]);\n                    }\n                }\n            }\n        }\n        return dest;\n    } else {\n        return dest !== undefined ? dest : source;\n    }\n}\n\n/**\n * Recursively import \"imports\" into the `expandedConfiguration` variable\n */\nfunction expandConfiguration(setts, importedPackages) {\n    setts = _.extend({}, setts);\n    var imports = setts.imports;\n    delete setts.imports;\n    expandedConfiguration = superExtend(expandedConfiguration, setts);\n\n    if (setts.packages && setts.packages.length > 0) {\n        setts.packages.forEach(function(name) {\n            if (!importedPackages[name]) {\n                imports.push(`/node_modules/${name}/`);\n                importedPackages[name] = true;\n            }\n        });\n    }\n\n    if (imports) {\n        return Promise.all(imports.map(function(imp) {\n            const promises = [];\n            if (imp[imp.length - 1] === '/') {\n                promises.push(configfs.readFile(`${imp}config.json`));\n                promises.push(configfs.readFile(`${imp}package.json`));\n            } else {\n                promises.push(configfs.readFile(imp));\n            }\n            return Promise.all(promises).then(function([text, pkgText]) {\n                var json;\n                try {\n                    json = JSON5.parse(text);\n\n                    if (pkgText) {\n                        const pkg = JSON.parse(pkgText);\n                        if (json.commands) {\n                            addUrlToCommands(json.commands, pkg.name, pkg.main);\n                        }\n                        if (json.modes) {\n                            Object.keys(json.modes).forEach(key => {\n                                const mode = json.modes[key];\n                                if (mode.commands) {\n                                    addUrlToCommands(mode.commands, pkg.name, pkg.main);\n                                }\n                            });\n                        }\n                    }\n                } catch (e) {\n                    console.error(\"In file\", imp, e);\n                    return;\n                }\n                resolveRelativePaths(json, imp);\n                return expandConfiguration(json, importedPackages);\n            }, function(err) {\n                console.warn(\"Error loading\", imp, err);\n            });\n        }));\n    } else {\n        return Promise.resolve();\n    }\n}\n\nfunction addUrlToCommands(commands, name, main) {\n    Object.keys(commands).forEach(cmd => {\n        commands[cmd].scriptUrl = `/node_modules/${name}/${main}`;\n    });\n}\n\nfunction makeUserBackup() {\n    return configfs.readFile(\"/user.json\").then(function(text) {\n        return configfs.writeFile(\"/user.backup.json\", text);\n    }, function(err) {\n        // Probably the file didn't exist, that's ok -- move on\n        return;\n    });\n}\n\nfunction writeUserPrefs() {\n    return configfs.writeFile(\"/user.json\", JSON5.stringify(userConfig, null, 4) + \"\\n\").\n    catch (function(err) {\n        console.error(\"Error during writing config:\", err);\n    });\n}\n\n/**\n * Loads config, deciding which config file to use as root:\n * - if a /zedconfig.json file exists in the project, use it\n * - otherwise use the /user.json file in the config project\n */\nfunction loadConfiguration() {\n    let goto = require('./goto');\n    if (goto && goto.getFileCache().indexOf(\"/zedconfig.json\") !== -1) {\n        return require(\"./fs\").readFile(\"/zedconfig.json\").then(function(text) {\n            var base = {};\n            try {\n                base = JSON5.parse(text);\n            } catch (e) {\n                console.error(\"Error parsing zedconfig.json\", e);\n            }\n            return loadUserConfiguration(base);\n        });\n    } else {\n        return loadUserConfiguration({});\n    }\n}\n\n\n/**\n * Extend the project config (or the empty object, if not present)\n * with config from /user.json from the config project\n */\nfunction loadUserConfiguration(base) {\n    var rootFile = \"/user.json\";\n    config = superExtend(base, minimumConfiguration);\n    expandedConfiguration = _.extend({}, config);\n    return configfs.readFile(rootFile).then(function(config_) {\n        var json = {};\n        try {\n            json = JSON5.parse(config_);\n            resolveRelativePaths(json, rootFile);\n        } catch (e) {\n            console.error(\"Error parsing /user.json\", e);\n        }\n        userConfig = json;\n        config = superExtend(config, json);\n        return expandConfiguration(config, {});\n    }).then(function() {\n        eventbus.emit(\"configchanged\", api);\n        return api;\n    });\n}\n\n/**\n * This function finds all relative script and import paths\n * (scriptUrl keys and for imports) and replaces them with\n * absolute ones\n */\nfunction resolveRelativePaths(configJson, jsonPath) {\n    var dir = path.dirname(jsonPath);\n    if (configJson.imports) {\n        configJson.imports = _.map(configJson.imports, function(imp) {\n            if (imp[0] === '.' && imp[1] === '/') {\n                return dir + imp.substring(1);\n            } else {\n                return imp;\n            }\n        });\n    }\n    if (configJson.commands) {\n        _.each(configJson.commands, function(cmd, name) {\n            if (cmd.scriptUrl && cmd.scriptUrl[0] === '.' && cmd.scriptUrl[1] === '/') {\n                configJson.commands[name].scriptUrl = dir + cmd.scriptUrl.substring(1);\n            }\n        });\n    }\n    if (configJson.modes) {\n        _.each(configJson.modes, function(mode) {\n            resolveRelativePaths(mode, jsonPath);\n        });\n    }\n    if (configJson.editor_themes) {\n        resolveThemes(configJson.editor_themes);\n    }\n    if (configJson.window_themes) {\n        resolveThemes(configJson.window_themes);\n    }\n    function resolveThemes(themes) {\n        _.each(themes, function(theme) {\n            if (!_.isArray(theme.css)) {\n                theme.css = [theme.css];\n            }\n            theme.css = _.map(theme.css, function(file) {\n                if (file[0] === '.' && file[1] === '/') {\n                    return dir + file.substring(1);\n                } else {\n                    return file;\n                }\n            });\n        });\n    }\n    return configJson;\n}\n\ncommand.define(\"Configuration:Reload\", {\n    doc: \"Reload Zed's configuration from disk.\",\n    exec: function() {\n        loadConfiguration();\n    },\n    readOnly: true\n});\n\ncommand.define(\"Configuration:Reset\", {\n    doc: \"Discard all Zed configuration and revert to factory settings.\",\n    exec: function() {\n        require(\"./ui\").prompt({\n            message: \"Are you sure you reset all config?\"\n        }).then(function(yes) {\n            if (yes) {\n                configfs.listFiles().then(function(files) {\n                    return Promise.all(files.map(function(path) {\n                        return configfs.deleteFile(path);\n                    })).then(function() {\n                        console.log(\"All files removed!\");\n                        return loadConfiguration();\n                    });\n                });\n            }\n        });\n    },\n    readOnly: true\n});\n\ncommand.define(\"Configuration:Show Full\", {\n    doc: \"Dump all configuration data into a temporary buffer called \" + \"`zed::config` for ready-only inspection.\",\n    exec: function(edit, session) {\n        return require(\"./session_manager\").go(\"zed::config\", edit, session).then(function(session) {\n            session.setMode(\"ace/mode/json\");\n            session.setValue(JSON5.stringify(expandedConfiguration, null, 4));\n        });\n    },\n    readOnly: true\n});\n\ncommand.define(\"Configuration:Open Configuration Project\", {\n    doc: \"Open a Zed window with the Configuration project\",\n    exec: function() {\n        background.then(bg => bg.openProject(\"Configuration\", window.isNodeWebkit ? \"nwconfig:\" : \"config:\"));\n    },\n    readOnly: true\n});\n\nsandboxes.defineInputable(\"preferences\", function() {\n    return expandedConfiguration.preferences;\n});\n\nmodule.exports = api;\n"]}