{"version":3,"sources":["../../src/js/handlers.js"],"names":["eventbus","require","config","command","editor","InlineAnnotation","opts","async","timeOutIds","timeOutMultiplicationFactor","api","hook","on","setTimeout","runSessionHandler","session","analyze","edit","didPreview","showPreview","emit","db","readStore","get","then","metaObj","initialIndex","indexOf","writeStore","put","indexProject","getActiveEditor","getActiveSession","updateHandlerTimeout","handlerName","path","startTime","minTimeout","timeOuts","Math","max","Date","now","getHandlerTimeout","defaultTimeout","timeOut","getHandlerCommandsForMode","mode","commandNames","handlers","concat","getHandlers","filter","cmdName","isVisible","lookup","debounceTimeout","filename","runCommands","results","before","Promise","all","map","commandName","resolve","exec","results_","length","id","clearTimeout","reject","setAnnotations","annos","annotations","forEach","anno","remove","i","endColumn","push","window","instant","isChange","modes","fs","allFiles","getFileCache","filesToIndex","getModeForPath","num","next","readFile","text","fakeSession","getTokenAt","getValue","getLines","split","err","console","log","done","define","readOnly","module","exports"],"mappings":"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","file":"handlers.js","sourcesContent":["'use strict';\n\nconst eventbus = require('./eventbus');\nconst config = require('./config');\nconst command = require('./command');\nconst editor = require('./editor');\n\nvar InlineAnnotation = require(\"./lib/inline_annotation\");\nvar opts = require(\"./lib/options\");\nvar async = require(\"./lib/async\");\n\n/**\n * This parts handles mode handlers, e.g. \"change\", \"preview\" etc.\n */\n\nvar timeOutIds = {};\nvar timeOutMultiplicationFactor = 3;\n\nvar api = {\n    hook: function() {\n        eventbus.on(\"configchanged\", function() {\n            // This looks bad, the reason we need to do this is to allow\n            // The command handler to update its sandbox commands, which happens\n            // within a tick\n            setTimeout(function() {\n                runSessionHandler(null, \"configchanged\");\n            });\n        });\n        eventbus.on(\"sessionbeforesave\", function(session) {\n            runSessionHandler(session, \"save\");\n        });\n        eventbus.on(\"sessionchanged\", function(session) {\n            analyze(session, null, true);\n        });\n        eventbus.on(\"modeset\", function(session) {\n            analyze(session);\n        });\n        eventbus.on(\"switchsession\", function(edit, session) {\n            analyze(session, true);\n        });\n        eventbus.on(\"preview\", function(session) {\n            var didPreview = runSessionHandler(session, \"preview\");\n            if (!didPreview) {\n                require(\"./preview\").showPreview(\"Not supported.\");\n                eventbus.emit(\"sessionactivityfailed\", session, \"No preview available\");\n            }\n        });\n        eventbus.on(\"sessionclicked\", function(edit, session) {\n            // We setTimeout this to make sure the cursor moved to the clicked\n            // position already\n            setTimeout(function() {\n                runSessionHandler(session, \"click\");\n            });\n        });\n        eventbus.on(\"dbavailable\", function(db) {\n            setTimeout(function() {\n                db.readStore(\"_meta\").get(\"meta\").then(function(metaObj) {\n                    if (!metaObj.initialIndex && opts.get('url').indexOf(\"http\") !== 0) {\n                        metaObj.initialIndex = true;\n                        db.writeStore(\"_meta\").put(metaObj);\n                        indexProject(editor.getActiveEditor(), editor.getActiveSession());\n                    }\n                });\n            }, 5000); // Don't start indexing immediately, give it a rest\n        });\n    },\n    runSessionHandler: runSessionHandler,\n    /**\n     * Used to implement adaptive timing. This method records the time it took\n     * to execute a particular handler and multiplies it with a multiplciation factor\n     * to be used in the next timeout, making sure that expensive handlers aren't\n     * using up all CPU cycles in the sandbox.\n     */\n    updateHandlerTimeout: function(handlerName, path, startTime, minTimeout) {\n        if (!timeOuts[handlerName]) {\n            timeOuts[handlerName] = {};\n        }\n        timeOuts[handlerName][path] = Math.max(minTimeout, (Date.now() - startTime) * timeOutMultiplicationFactor);\n    },\n    getHandlerTimeout: function(handlerName, path, defaultTimeout) {\n        if (!timeOuts[handlerName]) {\n            return defaultTimeout;\n        }\n        var timeOut = timeOuts[handlerName][path];\n        return timeOut ? Math.max(defaultTimeout, timeOut) : defaultTimeout;\n    },\n};\n\nfunction getHandlerCommandsForMode(handlerName, mode) {\n    var commandNames = [];\n\n    if (mode && mode.handlers[handlerName]) {\n        commandNames = commandNames.concat(mode.handlers[handlerName]);\n    }\n    if (config.getHandlers()[handlerName]) {\n        commandNames = commandNames.concat(config.getHandlers()[handlerName]);\n    }\n    commandNames = commandNames.filter(function(cmdName) {\n        return command.isVisible({ // Fake session\n            mode: mode\n        }, command.lookup(cmdName), true);\n    });\n    return commandNames;\n}\n\nfunction runSessionHandler(session, handlerName, debounceTimeout) {\n    var path, commandNames = [];\n    if (session) {\n        path = session.filename;\n        commandNames = getHandlerCommandsForMode(handlerName, session.mode);\n    } else {\n        path = \"\";\n        if (config.getHandlers()[handlerName]) {\n            commandNames = config.getHandlers()[handlerName];\n        }\n        session = editor.getActiveSession();\n    }\n\n    function runCommands() {\n        var results = [];\n        var edit = editor.getActiveEditor();\n        var before = Date.now();\n\n        return Promise.all(commandNames.map(function(commandName) {\n            return Promise.resolve(command.exec(commandName, edit, session)).then(function(results_) {\n                results = results.concat(results_);\n            });\n        })).then(function() {\n            api.updateHandlerTimeout(handlerName, session.filename, before, debounceTimeout);\n            return results;\n        });\n    }\n\n    if (commandNames.length > 0) {\n        if (debounceTimeout) {\n            var id = path + ':' + handlerName;\n            clearTimeout(timeOutIds[id]);\n            return new Promise(function(resolve, reject) {\n                timeOutIds[id] = setTimeout(function() {\n                    runCommands().then(resolve, reject);\n                }, debounceTimeout);\n            });\n        } else {\n            return runCommands();\n        }\n    } else {\n        return Promise.resolve(false);\n    }\n}\n\nfunction setAnnotations(session, annos) {\n    annos = annos || [];\n    (session.annotations || []).forEach(function(anno) {\n        anno.remove();\n    });\n    session.annotations = [];\n    for (var i = 0; i < annos.length; i++) {\n        var anno = annos[i];\n        // If no endColum, no inline marker is required\n        if (anno.endColumn) {\n            session.annotations.push(new InlineAnnotation(session, anno));\n        }\n    }\n    session.setAnnotations(annos);\n}\n\n\n// handlerName -> { path -> timeout }\nvar timeOuts = {};\nwindow.timeOuts = timeOuts;\n\n// window.timeOuts = timeOuts;\n\n/**\n * Analyzes session and sets findings as annotations\n * @param session session object\n * @param instant perform handler instantly\n * @param isInit is set to true when this handler is called only initially (i.e. not after a change)\n */\nfunction analyze(session, instant, isChange) {\n    if(isChange) {\n        runSessionHandler(session, \"change\", 1000);\n    }\n    runSessionHandler(session, \"index\", instant ? null : api.getHandlerTimeout(\"index\", session.filename, 1000));\n    runSessionHandler(session, \"check\", instant ? null : api.getHandlerTimeout(\"check\", session.filename, 2000)).then(function(annos) {\n        setAnnotations(session, annos);\n    });\n}\n\nfunction indexProject(edit, session) {\n    var modes = require(\"./modes\");\n    var fs = require(\"./fs\");\n    var allFiles = require(\"./goto\").getFileCache();\n    var filesToIndex = allFiles.filter(function(path) {\n        var mode = modes.getModeForPath(path);\n        return getHandlerCommandsForMode(\"index\", mode).length > 0;\n    });\n\n    var num = 0;\n\n    async.forEach(filesToIndex, function(path, next) {\n        num++;\n        eventbus.emit(\"sessionactivitystarted\", session, \"Indexing \" + num + \" of \" + filesToIndex.length);\n        var mode = modes.getModeForPath(path);\n        // console.log(\"Indexing\", path);\n        fs.readFile(path).then(function(text) {\n            var fakeSession = {\n                filename: path,\n                mode: mode,\n                getTokenAt: true,\n                getValue: function() {\n                    return text;\n                },\n                getLines: function() {\n                    return text.split(\"\\n\");\n                }\n            };\n            runSessionHandler(fakeSession, \"index\", null).then(next);\n        }, function(err) {\n            console.log(\"Could not load\", path, err);\n            next();\n        });\n    }, function done() {\n        eventbus.emit(\"sessionactivitystarted\", session, \"Indexing complete\");\n        setTimeout(function() {\n            eventbus.emit(\"sessionactivitycompleted\", session);\n        }, 2000);\n    });\n}\n\ncommand.define(\"Tools:Index Project\", {\n    exec: indexProject,\n    readOnly: true\n});\n\nmodule.exports = api;\n"]}