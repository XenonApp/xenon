{"version":3,"sources":["../../src/js/action.js"],"names":["command","require","runSessionHandler","AcePopup","global","ace","HashHandler","showActions","edit","session","popup","document","body","documentElement","$","container","addClass","keyboardHandler","bindKeys","go","close","runFix","setData","caption","show","then","results","length","map","handlerResultToFixResult","setTimeout","err","console","error","renderer","setFontSize","getFontSize","cursorPos","getCursorPosition","lineHeight","layerConfig","pos","$cursorLayer","getPixelPosition","left","getTextLeftOffset","rect","getBoundingClientRect","top","offset","scrollLeft","$gutterLayer","gutterWidth","on","e","stop","init","action","getData","getRow","onSelect","keyBinding","addKeyboardHandler","where","row","max","getLength","setRow","remove","removeKeyboardHandler","off","result","meta","getSession","$cmdInfo","info","exec","define","doc"],"mappings":"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","file":"action.js","sourcesContent":["'use strict';\n\nconst command = require('./command');\nconst runSessionHandler = require('./handlers').runSessionHandler;\n\nvar AcePopup = global.ace.require(\"ace/autocomplete/popup\").AcePopup;\nvar HashHandler = global.ace.require(\"ace/keyboard/hash_handler\").HashHandler;\n\nfunction showActions(edit, session) {\n    var popup = new AcePopup(document.body || document.documentElement);\n    $(popup.container).addClass(\"actionbox\");\n    var keyboardHandler = new HashHandler();\n    keyboardHandler.bindKeys({\n        \"Up\": function() {\n            go(\"up\");\n        },\n        \"Down\": function() {\n            go(\"down\");\n        },\n        \"Esc\": function() {\n            close();\n        },\n        \"Return\": function() {\n            runFix();\n        }\n    });\n\n    //popup.setData(actions);\n    popup.setData([{\n        caption: \"Loading...\"\n    }]);\n    show();\n    runSessionHandler(session, \"action\").then(function(results) {\n        if (results && results.length > 0) {\n            popup.setData(results.map(handlerResultToFixResult));\n        } else {\n            popup.setData([{caption: \"No actions available.\"}]);\n            setTimeout(function() {\n                close();\n            }, 1000);\n        }\n    }, function(err) {\n        console.error(\"Error running action\", err);\n    });\n\n    function show() {\n        var renderer = edit.renderer;\n        popup.setFontSize(edit.getFontSize());\n        var cursorPos = edit.getCursorPosition();\n\n        var lineHeight = renderer.layerConfig.lineHeight;\n\n        var pos = renderer.$cursorLayer.getPixelPosition(cursorPos, true);\n        pos.left -= popup.getTextLeftOffset();\n\n        var rect = edit.container.getBoundingClientRect();\n        pos.top += rect.top - renderer.layerConfig.offset;\n        pos.left += rect.left - edit.renderer.scrollLeft;\n        pos.left += renderer.$gutterLayer.gutterWidth;\n\n        popup.show(pos, lineHeight);\n        popup.on(\"click\", function(e) {\n            runFix();\n            e.stop();\n        });\n        init();\n    }\n\n    function runFix() {\n        var action = popup.getData(popup.getRow());\n        close();\n        action.onSelect(edit);\n    }\n\n    function init() {\n        edit.keyBinding.addKeyboardHandler(keyboardHandler);\n        edit.on(\"changeSelection\", close);\n        // edit.on(\"blur\", close);\n        edit.on(\"mousedown\", close);\n        edit.on(\"mousewheel\", close);\n    }\n\n    function go(where) {\n        var row = popup.getRow();\n        var max = popup.session.getLength() - 1;\n\n        switch (where) {\n            case \"up\":\n                row = row < 0 ? max : row - 1;\n                break;\n            case \"down\":\n                row = row >= max ? -1 : row + 1;\n                break;\n            case \"start\":\n                row = 0;\n                break;\n            case \"end\":\n                row = max;\n                break;\n        }\n\n        popup.setRow(row);\n    }\n\n    function close() {\n        $(popup.container).remove();\n        edit.keyBinding.removeKeyboardHandler(keyboardHandler);\n        edit.off(\"changeSelection\", close);\n        edit.off(\"blur\", close);\n        edit.off(\"mousedown\", close);\n        edit.off(\"mousewheel\", close);\n    }\n}\n\n/**\n * Result format:\n * {\n *    caption: \"Do ABC\"\n *    command: \"Some:Command\",\n *    info: { random data},\n *    score: number\n * }\n *\n */\n\nfunction handlerResultToFixResult(result) {\n    return {\n        caption: result.caption,\n        meta: \"action\",\n        onSelect: function(edit) {\n            var session = edit.getSession();\n            // SUPER ugly hack to pass in additional info to the command\n            session.$cmdInfo = result.info;\n            command.exec(result.command, edit, session);\n        }\n    };\n}\n\ncommand.define(\"Tools:Action\", {\n    doc: \"\", // I don't actually know what this does -robru\n    exec: function(edit, session) {\n        showActions(edit, session);\n    }\n});\n"]}