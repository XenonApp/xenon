{"version":3,"sources":["../../src/js/sandbox_webworker.js"],"names":["importScripts","debug","self","window","define","load","name","req","onload","config","sandboxRequest","then","text","fromText","amdTransformer","err","console","error","absPath","abs","rel","absParts","split","relParts","pop","i","length","concat","slice","join","moduleAbsPath","source","exec","replace","all","q","mod","newMod","indexOf","id","waitingForReply","module","call","args","Promise","resolve","reject","postMessage","type","handleApiResponse","event","data","p","replyTo","undefined","result","onmessage","url","require","fn","message","log","oldLog","oldWarn","warn","oldError","info","oldInfo","noop","onerror","filename","lineno","stack","level","oldFn","toLogEntry","s","_","each","arg","isString","JSON5","stringify","arguments"],"mappings":"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","file":"sandbox_webworker.js","sourcesContent":["/*global define, sandboxRequest, _, self, Promise, importScripts, onmessage, postMessage*/\nimportScripts(\"../dep/require.js\", \"../dep/underscore-min.js\", \"../dep/json5.js\");\nvar debug = false;\n\nself.window = self;\n\ndefine(\"configfs\", [], {\n    load: function(name, req, onload, config) {\n        sandboxRequest(\"zed/configfs\", \"readFile\", [name]).then(function(text) {\n            onload.fromText(amdTransformer(name, text));\n        }, function(err) {\n            return console.error(\"Error while loading file\", name, err);\n        });\n    }\n});\n\nfunction absPath(abs, rel) {\n    var absParts = abs.split('/');\n    var relParts = rel.split('/');\n    absParts.pop(); // dir\n    for(var i = 0; i < relParts.length; i++) {\n        if(relParts[i] === '.') {\n            continue;\n        }\n        if(relParts[i] === '..') {\n            absParts.pop();\n            continue;\n        }\n        absParts = absParts.concat(relParts.slice(i));\n        break;\n    }\n    return absParts.join('/');\n}\n\n/**\n * This rewrites extension code in two minor ways:\n * - requires are rewritten to all point to configfs!\n * - AMD wrappers are added if they're not already there'\n */\nfunction amdTransformer(moduleAbsPath, source) {\n    // If this source file is not doing funky stuff like overriding require\n    if (!/require\\s*=/.exec(source)) {\n        source = source.replace(/require\\s*\\(([\"'])(.+)[\"']\\)/g, function(all, q, mod) {\n            var newMod = mod;\n            if (mod.indexOf(\"zed/\") === 0) {\n                newMod = \"configfs!/api/\" + mod;\n            } else if (mod.indexOf(\".\") === 0) {\n                newMod = \"configfs!\" + absPath(moduleAbsPath, mod);\n            } else {\n                return all;\n            }\n            return \"require(\" + q + newMod + (/\\.js$/.exec(newMod) ? \"\" : \".js\") + q + \")\";\n        });\n    }\n    // If no AMD wrapper is there yet, add it\n    if (source.indexOf(\"define(function(\") === -1) {\n        source = \"define(function(require, exports, module) {\" + source + \"\\n});\";\n    }\n    return source;\n}\n\nvar id = 0;\nvar waitingForReply = {};\n\nself.sandboxRequest = function(module, call, args) {\n    return new Promise(function(resolve, reject) {\n        id++;\n        waitingForReply[id] = {\n            resolve: resolve,\n            reject: reject\n        };\n        postMessage({\n            type: \"request\",\n            id: id,\n            module: module,\n            call: call,\n            args: args\n        });\n    });\n};\n\nfunction handleApiResponse(event) {\n    var data = event.data;\n    var p = waitingForReply[data.replyTo];\n\n    if (undefined !== data.err && null !== data.err) {\n        p.reject(data.err);\n    } else {\n        p.resolve(data.result);\n    }\n    delete waitingForReply[data.replyTo];\n}\n\nonmessage = function(event) {\n    var data = event.data;\n    var id = data.id;\n    var url = data.url;\n\n    if (data.replyTo) {\n        return handleApiResponse(event);\n    }\n    if (!url) {\n        return;\n    }\n\n    require([url], function(fn) {\n        Promise.resolve(data.data).then(fn).then(function(result) {\n            var message = {\n                replyTo: id,\n                result: result\n            };\n            if (debug) {\n                console.log(message);\n            }\n            postMessage(message);\n        }, function(err) {\n            var message = {\n                replyTo: id,\n                err: err\n            };\n            postMessage(message);\n        });\n    });\n};\n\n// Override console.log etc\nvar oldLog = console.log;\nvar oldWarn = console.warn;\nvar oldError = console.info;\nvar oldInfo = console.info;\nvar noop = function() {};\nconsole.log = log(\"log\", oldLog);\nconsole.warn = log(\"warn\", oldWarn);\nconsole.error = log(\"error\", oldError);\nconsole.info = log(\"info\", oldInfo);\n\nonerror = function(err) {\n    log(\"error\", noop)(err.message, err.filename, err.lineno, err.stack);\n};\n\nfunction log(level, oldFn) {\n    function toLogEntry(args) {\n        var s = '';\n        _.each(args, function(arg) {\n            if (_.isString(arg)) {\n                s += arg;\n            } else {\n                s += JSON5.stringify(arg, null, 2);\n            }\n            s += ' ';\n        });\n        return s;\n    }\n    return function() {\n        postMessage({\n            type: \"log\",\n            level: level,\n            message: toLogEntry(arguments)\n        });\n        // sandboxRequest(\"zed/log\", \"log\", [level, toLogEntry(arguments)]).then(function() {});\n    };\n}\n"]}