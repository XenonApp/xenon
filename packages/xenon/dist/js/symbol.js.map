{"version":3,"sources":["../../src/js/symbol.js"],"names":["dbP","require","eventbus","async","LAST_CHAR","String","fromCharCode","api","updateSymbols","queueUntilEvent","path","symbolInfos","db","get","readStore","index","query","then","currentSymbols","writeStore","deletePromises","i","length","sym","push","delete","id","Promise","all","putPromises","forEach","symbolInfo","lcSymbol","symbol","toLowerCase","locator","symbol_lc","put","getSymbols","opts","prefix","limit","getAll","module","exports"],"mappings":"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","file":"symbol.js","sourcesContent":["\"use strict\";\n\nconst dbP = require('./db');\nconst eventbus = require('./eventbus');\n\nvar async = require(\"./lib/async\");\n\nvar LAST_CHAR = String.fromCharCode(255);\n\nvar api = {\n    updateSymbols: async.queueUntilEvent(eventbus, \"dbavailable\", function(path, symbolInfos) {\n        var db = dbP.get();\n        return db.readStore(\"symbols\").index(\"path_sym\").query(\">=\", [path, \"\"], \"<=\", [path, \"~\"]).then(function(currentSymbols) {\n            var writeStore = db.writeStore(\"symbols\");\n            var deletePromises = [];\n            for (var i = 0; i < currentSymbols.length; i++) {\n                var sym = currentSymbols[i];\n                deletePromises.push(writeStore.delete(sym.id));\n            }\n            return Promise.all(deletePromises);\n        }).then(function() {\n            var writeStore = db.writeStore(\"symbols\");\n            var putPromises = [];\n            symbolInfos.forEach(function(symbolInfo) {\n                var lcSymbol = symbolInfo.symbol.toLowerCase();\n                symbolInfo.id = lcSymbol + \"~\" + path + \"~\" + symbolInfo.locator;\n                symbolInfo.symbol_lc = lcSymbol;\n                putPromises.push(writeStore.put(symbolInfo));\n            });\n            return Promise.all(putPromises);\n        });\n    }),\n    getSymbols: async.queueUntilEvent(eventbus, \"dbavailable\", function(opts) {\n        opts = opts || {};\n        if(opts.prefix) {\n            opts.prefix = opts.prefix.toLowerCase();\n        }\n        var db = dbP.get();\n        if (opts.path && !opts.prefix) {\n            return db.readStore(\"symbols\").index(\"path_sym\").query(\">=\", [opts.path, \"\"], \"<=\", [opts.path, LAST_CHAR], {\n                limit: opts.limit\n            });\n        } else if (opts.prefix && !opts.path) {\n            return db.readStore(\"symbols\").query(\">=\", opts.prefix, \"<=\", opts.prefix + LAST_CHAR, {\n                limit: opts.limit\n            });\n        } else if (opts.prefix && opts.path) {\n            return db.readStore(\"symbols\").index(\"path_sym\").query(\">=\", [opts.path, opts.prefix], \"<=\", [opts.path, opts.prefix + LAST_CHAR], {\n                limit: opts.limit\n            });\n        } else {\n            return db.readStore(\"symbols\").getAll(null, {\n                limit: opts.limit\n            });\n        }\n    })\n};\n\nmodule.exports = api;\n"]}