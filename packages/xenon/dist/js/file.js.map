{"version":3,"sources":["../../src/js/file.js"],"names":["ui","require","eventbus","command","fs","session_manager","goto","useragent","global","ace","path","confirmDelete","edit","getSession","filename","prompt","message","then","yes","emit","deleteFile","deleteSession","go","err","renameFile","session","console","log","input","newPath","comparePath","compareNewPath","isMac","toLowerCase","readFile","actuallyRenameFile","writeFile","getValue","handleChangedFile","catch","copyFile","define","doc","exec","currentPath","dir","dirname","readOnly","prefix","listFiles","files","_","filter","indexOf","Promise","all","map","file","fetchFileList"],"mappings":"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","file":"file.js","sourcesContent":["'use strict';\n/**\n * This module implements miscelaneous file operations (delete, rename)\n */\n \nconst ui = require('./ui');\nconst eventbus = require('./eventbus');\nconst command = require('./command');\nconst fs = require('./fs');\nconst session_manager = require('./session_manager');\nconst goto = require('./goto');\n\nvar useragent = global.ace.require(\"ace/lib/useragent\");\nvar path = require(\"./lib/path\");\n\nfunction confirmDelete(edit) {\n    var path = edit.getSession().filename;\n    return ui.prompt({\n        message: \"Are you sure you want to delete \" + path + \"?\"\n    }).then(function(yes) {\n        if (yes) {\n            eventbus.emit(\"sessionactivitystarted\", edit.getSession(), \"Deleting\");\n            return fs.deleteFile(path).then(function() {\n                session_manager.deleteSession(path);\n                eventbus.emit(\"sessionactivitycompleted\", edit.getSession());\n                session_manager.go('zed::start', edit);\n            }, function(err) {\n                return eventbus.emit(\"sessionactivityfailed\", edit.getSession(), \"Could not delete file: \" + err);\n            });\n        }\n    });\n}\n\nfunction renameFile(edit) {\n    var session = edit.getSession();\n    var path = session.filename;\n    console.log(\"Filename\", path);\n    return ui.prompt({\n        message: \"New name:\",\n        input: path\n    }).then(function(newPath) {\n        var comparePath = path;\n        var compareNewPath = newPath;\n        if (useragent.isMac) {\n            comparePath = path.toLowerCase();\n            compareNewPath = newPath.toLowerCase();\n        }\n        if (newPath && comparePath !== compareNewPath) {\n            eventbus.emit(\"sessionactivitystarted\", edit.getSession(), \"Renaming\");\n            fs.readFile(newPath).then(function() {\n                ui.prompt({\n                    message: \"Are you sure you want to delete the current file at \" + newPath + \"?\"\n                }).then(function(yes) {\n                    if (yes) {\n                        return actuallyRenameFile(edit, session, path, newPath);\n                    } else {\n                        eventbus.emit(\"sessionactivitycompleted\", edit.getSession());\n                    }\n                });\n            }, function(err) {\n                actuallyRenameFile(edit, session, path, newPath);\n            });\n        }\n    });\n}\n\nfunction actuallyRenameFile(edit, session, path, newPath) {\n    return fs.writeFile(newPath, session.getValue()).then(function() {\n        // TODO: Copy session state\n        session_manager.handleChangedFile(newPath);\n        session_manager.go(newPath, edit);\n        return fs.deleteFile(path).then(function() {\n            session_manager.deleteSession(path);\n            eventbus.emit(\"sessionactivitycompleted\", edit.getSession());\n        });\n    }).\n    catch (function(err) {\n        eventbus.emit(\"sessionactivityfailed\", edit.getSession(), \"Could not write to file: \" + err);\n    });\n}\n\nfunction copyFile(edit) {\n    var session = edit.getSession();\n    var path = session.filename;\n    console.log(\"Filename\", path);\n    ui.prompt({\n        message: \"Copy to path:\",\n        input: path\n    }).then(function(newPath) {\n        if (newPath) {\n            eventbus.emit(\"sessionactivitystarted\", edit.getSession(), \"Copying\");\n            return fs.writeFile(newPath, session.getValue()).then(function() {\n                // TODO: Copy session state\n                session_manager.go(newPath, edit);\n                eventbus.emit(\"sessionactivitycompleted\", edit.getSession());\n            }, function(err) {\n                eventbus.emit(\"sessionactivityfailed\", edit.getSession(), \"Could not write to file: \" + err);\n            });\n        }\n    });\n}\n\ncommand.define(\"File:New\", {\n    doc: \"Create a new file\",\n    exec: function(edit, session) {\n        var currentPath = session.filename;\n        var dir = path.dirname(currentPath);\n        command.exec(\"Navigate:Goto\", edit, session, dir + \"/\");\n    },\n    readOnly: true\n});\n\ncommand.define(\"File:Delete\", {\n    doc: \"Remove the current file from disk.\",\n    exec: function(edit) {\n        confirmDelete(edit);\n    }\n});\n\ncommand.define(\"File:Rename\", {\n    doc: \"Rename the current file on disk.\",\n    exec: function(edit) {\n        renameFile(edit);\n    }\n});\n\ncommand.define(\"File:Copy\", {\n    doc: \"Copy the current file to a new path on disk.\",\n    exec: function(edit) {\n        copyFile(edit);\n    }\n});\n\ncommand.define(\"File:Delete Tree\", {\n    doc: \"Recursively delete a directory, and all subdirectories and files contained within.\",\n    exec: function() {\n        ui.prompt({\n            message: \"Prefix of tree to delete:\",\n            input: \"\"\n        }).then(function(prefix) {\n            if (prefix) {\n                ui.prompt({\n                    message: \"Are you sure you want to delete all files under \" + prefix + \"?\"\n                }).then(function(yes) {\n                    if (!yes) {\n                        return;\n                    }\n                    return fs.listFiles().then(function(files) {\n                        files = _.filter(files, function(path) {\n                            return path.indexOf(prefix) === 0;\n                        });\n                        return Promise.all(files.map(function(file) {\n                            return fs.deleteFile(file);\n                        })).then(function() {\n                            goto.fetchFileList();\n                            console.log(\"All files under\", prefix, \"removed!\");\n                        });\n                    });\n                });\n            }\n        });\n    },\n    readOnly: true\n});"]}