{"version":3,"sources":["../../../../src/js/sandbox/zed/session.js"],"names":["Range","global","ace","require","InlineAnnotation","rangify","range","fromPoints","start","end","getSession","path","session","getActiveSession","console","error","useInputable","inputableName","Promise","resolve","getInputable","identifierRegex","module","exports","getAllLines","getCursorIndex","getCursorPosition","getCursorPositions","getScrollPosition","getSelectionRange","getSelectionText","getText","isInsertingSnippet","callCommand","command","info","$cmdInfo","exec","getActiveEditor","goto","edit","go","then","deleteSession","sessions","getSessions","setAnnotations","annos","annotations","forEach","anno","log","remove","i","length","endColumn","push","setText","text","scrollTop","getScrollTop","scrollLeft","getScrollLeft","cursorPos","selection","getCursor","lineCount","getLength","getLine","replace","clearSelection","moveCursorToPosition","setScrollTop","setScrollLeft","insertAtCursor","insert","pos","append","row","column","getPreceedingIdentifier","doc","getDocument","line","identBuf","test","reverse","join","removeInLine","removeLines","removeFullLines","getTextRange","setCursorIndex","index","getValue","slice","lines","split","setCursorPosition","setScrollPosition","replaceRange","getModeName","mode","language","flashClearId","flashMessage","message","clearTimeout","emit","setTimeout"],"mappings":"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","file":"session.js","sourcesContent":["'use strict';\n    \nvar Range = global.ace.require(\"ace/range\").Range;\nvar InlineAnnotation = require(\"../../lib/inline_annotation\");\n\nfunction rangify(range) {\n    return Range.fromPoints(range.start, range.end);\n}\n\nfunction getSession(path) {\n    var session = path ? require(\"../../session_manager\").getSession(path) : require(\"../../editor\").getActiveSession();\n    if (!session) {\n        console.error(\"Could not get session:\", path);\n        // TODO once we switch this to promises\n    }\n    return session;\n}\n\n\nfunction useInputable(inputableName) {\n    return function(path) {\n        return Promise.resolve(require(\"../../sandboxes\").getInputable(getSession(path), inputableName));\n    };\n}\n\nvar identifierRegex = /[a-zA-Z_0-9\\$\\-]/;\n\nmodule.exports = {\n    getAllLines: useInputable(\"lines\"),\n    getCursorIndex: useInputable(\"cursorIndex\"),\n    getCursorPosition: useInputable(\"cursor\"),\n    getCursorPositions: useInputable(\"cursors\"),\n    getScrollPosition: useInputable(\"scrollPosition\"),\n    getSelectionRange: useInputable(\"selectionRange\"),\n    getSelectionText: useInputable(\"selectionText\"),\n    getText: useInputable(\"text\"),\n    isInsertingSnippet: useInputable(\"isInsertingSnippet\"),\n    callCommand: function(path, command, info) {\n        var session = getSession(path);\n        if(info) {\n            session.$cmdInfo = info;\n        }\n        return require(\"../../command\").exec(command,  require(\"../../editor\").getActiveEditor(), session);\n    },\n    goto: function(path) {\n        var edit = require(\"../../editor\").getActiveEditor();\n        return require(\"../../session_manager\").go(path, edit, edit.getSession()).then(function() {\n            return; // Return nothing\n        });\n    },\n    deleteSession: function(path) {\n        var sessions = require(\"../../session_manager\").getSessions();\n        delete sessions[path];\n        return Promise.resolve();\n    },\n    setAnnotations: function(path, annos) {\n        var session = getSession(path);\n        (session.annotations || []).forEach(function(anno) {\n            console.log(\"Removing anno\", anno);\n            anno.remove();\n        });\n        session.annotations = [];\n        for (var i = 0; i < annos.length; i++) {\n            var anno = annos[i];\n            // If no endColum, no inline marker is required\n            if (anno.endColumn) {\n                session.annotations.push(new InlineAnnotation(session, anno));\n            }\n        }\n        session.setAnnotations(annos);\n        return Promise.resolve();\n    },\n    // Don't use setText unless you are really changing the entire contents\n    // of the document, because it interacts poorly with the selection,\n    // cursor position, undo history, etc.\n    setText: function(path, text) {\n        var session = getSession(path);\n\n        // Save scroll/cursor state\n        var scrollTop = session.getScrollTop();\n        var scrollLeft = session.getScrollLeft();\n        var cursorPos = session.selection.getCursor();\n\n        var lineCount = session.getLength();\n        var range = new Range(0, 0, lineCount, session.getLine(lineCount - 1).length);\n\n        session.replace(range, text);\n\n        session.selection.clearSelection();\n        session.selection.moveCursorToPosition(cursorPos);\n        session.setScrollTop(scrollTop);\n        session.setScrollLeft(scrollLeft);\n        return Promise.resolve();\n    },\n    insertAtCursor: function(path, text) {\n        var session = getSession(path);\n        session.insert(session.selection.getCursor(), text);\n        return Promise.resolve();\n    },\n    insert: function(path, pos, text) {\n        var session = getSession(path);\n        session.insert(pos, text);\n        return Promise.resolve();\n    },\n    append: function(path, text) {\n        var session = getSession(path);\n        session.insert({\n            row: session.getLength(),\n            column: 0\n        }, text);\n        return Promise.resolve();\n    },\n    getPreceedingIdentifier: function(path) {\n        var session = getSession(path);\n        var doc = session.getDocument();\n        var pos = session.selection.getCursor();\n        var line = doc.getLine(pos.row);\n\n        var identBuf = [];\n        for (var i = pos.column - 1; i >= 0; i--) {\n            if (identifierRegex.test(line[i])) {\n                identBuf.push(line[i]);\n            } else {\n                break;\n            }\n        }\n        return Promise.resolve(identBuf.reverse().join(\"\"));\n    },\n    removeInLine: function(path, row, start, end) {\n        getSession(path).getDocument().removeInLine(row, start, end);\n        return Promise.resolve();\n    },\n    removeLines: function(path, start, end) {\n        getSession(path).getDocument().removeFullLines(start, end);\n        return Promise.resolve();\n    },\n    getTextRange: function(path, start, end) {\n        return Promise.resolve(getSession(path).getTextRange(rangify({\n            start: start,\n            end: end\n        })));\n    },\n    setCursorIndex: function(path, index) {\n        var session = getSession(path);\n        var text = session.getValue().slice(0, index);\n        var lines = text.split(\"\\n\");\n        var pos = {\n            row: lines.length - 1,\n            column: lines[lines.length - 1].length\n        };\n        session.selection.clearSelection();\n        session.selection.moveCursorToPosition(pos);\n        return Promise.resolve();\n    },\n    setCursorPosition: function(path, pos) {\n        var session = getSession(path);\n        session.selection.clearSelection();\n        session.selection.moveCursorToPosition(pos);\n        return Promise.resolve();\n    },\n    setScrollPosition: function(path, pos) {\n        var session = getSession(path);\n        session.setScrollTop(pos.scrollTop);\n        session.setScrollLeft(pos.scrollLeft);\n        return Promise.resolve();\n    },\n    replaceRange: function(path, range, text) {\n        var session = getSession(path);\n        var cursorPos = session.selection.getCursor();\n\n        session.replace(rangify(range), text);\n\n        session.selection.clearSelection();\n        session.selection.moveCursorToPosition(cursorPos);\n        return Promise.resolve();\n    },\n    getModeName: function(path) {\n        return Promise.resolve(getSession(path).mode.language);\n    },\n    flashClearId: null,\n    flashMessage: function(path, message, length) {\n        if(this.flashClearId) {\n            clearTimeout(this.flashClearId);\n        }\n        var session = getSession(path);\n        require(\"../../eventbus\").emit(\"sessionactivitystarted\", session, message);\n        this.flashClearId = setTimeout(function() {\n            require(\"../../eventbus\").emit(\"sessionactivitycompleted\", session);\n        }, length);\n        return Promise.resolve();\n    }\n};\n"]}